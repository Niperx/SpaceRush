# space-chaos.agent
name: Space Chaos
version: 0.7.0
description: |
  Многопользовательская браузерная игра «каждый игрок — планета».
  Полностью на Canvas 2D + Socket.io. Без Three.js и тяжёлых фреймворков.

  Основные идентификаторы — никнеймы (не socket.id).
  Планета сохраняется между перезагрузками вкладки, если ник не был самоуничтожен.
  При поражении в бою — планета полностью уничтожается, игрок видит экран смерти
  с информацией о бое и может заново создать планету (с тем же или новым ником).

# ── Технологический стек ─────────────────────────────────────
tech-stack:
  frontend:
    - HTML5 + Canvas 2D (все визуальные элементы рисуются вручную)
    - Второй canvas для bloom-эффекта (filter: blur + mix-blend-mode: screen)
    - Vanilla JavaScript (ES2023+)
    - Socket.io-client ^4.7.5
    - localStorage (хранение никнейма, языка, состояния подсказок)
    - Локализация RU/EN (переключатель в углу, сохраняется в localStorage)

  backend:
    - Node.js 20+
    - Express
    - Socket.io ^4.7.5
    - Redis (ioredis ^5.4.1) — персистентность игроков (player:{nick}, set players:nicks)
    - Данные загружаются из Redis при старте, сохраняются при каждом изменении

  инфраструктура:
    - Docker Compose: app + Redis (redis:7-alpine, appendonly yes)
    - Сервер слушает на 0.0.0.0 (доступен по LAN)

  запуск:
    - Один файл index.html (открывается в браузере)
    - Один файл server.js

# ── Структура проекта ────────────────────────────────────────
files:
  - server.js          # основной сервер, игровая логика, сокеты, миссии, астероиды
  - index.html         # весь клиент (canvas + bloom + UI + ввод ника + мини-карта)
  - .agent             # этот файл — контекст для разработчиков / AI
  - package.json       # зависимости
  - docker-compose.yml # Docker Compose (app + Redis)
  - Dockerfile         # сборка контейнера (если есть)

# ── Как запускать ────────────────────────────────────────────
run:
  install: npm install
  start: node server.js  # без Redis — пустой мир; с Redis — REDIS_HOST=localhost (или запустить redis локально)
  docker: docker-compose up --build  # app + Redis в одном компоузере
  client: открыть http://localhost:3000 в браузере
  dev: открыть несколько вкладок → проверить мультиплеер

# ── Зависимости ──────────────────────────────────────────────
dependencies:
  express: ^4.19.2
  socket.io: ^4.7.5
  ioredis: ^5.4.1

# ── Основные механики (актуальное состояние v0.7) ─────────────
mechanics:
  идентификация:
    - Никнейм (3–16 символов) вводится один раз
    - Сохраняется в localStorage
    - При перезагрузке вкладки — восстанавливается планета того же ника
    - При смерти в бою: планета полностью удаляется, игрок получает экран поражения
    - На экране поражения: кто убил, потерянные ресурсы, уровень, флот
    - Игрок вводит ник заново (может тот же или новый) и создаёт новую планету
    - Самоуничтожение: удаляет запись игрока → ник освобождается

  планета:
    - x, y (случайные при создании, минимум 500px от других игроков)
    - Если негде заспавниться в пределах карты — карта автоматически расширяется
    - lvl (экономический уровень, влияет на доход)
    - res (ресурсы)
    - fleet (флот для атак и шахтёров)
    - defense (щит, покупается и регенерирует)
    - militaryLvl (бонус к атаке и скорости флота)
    - fortLvl (макс defense + авторегенерация)
    - lastAttack (timestamp для кулдауна)
    - last_seen (timestamp для определения оффлайн-игроков)

  экономика:
    - + (lvl × 8) res каждую секунду
    - Три ветки улучшений (Economy, Military, Fortification)
    - Покупка fleet (10 res за ед.) и defense (15 res за ед.)
    - Астероидное поле: 12 астероидов (50–200 res), респавн 60 сек
    - Добыча астероидов: отправка 1 fleet как шахтёра (летит, добывает, возвращается)

  дерево_улучшений:
    - Economy (lvl): увеличивает доход res/сек. Цена: 100 × 1.6^(lvl-1)
    - Military: +5% бонус к атаке и +10% скорости флота за уровень. Цена: 120 × 1.7^lvl
    - Fortification: +10 макс defense и +0.5 авторегенерация за уровень. Цена: 100 × 1.5^lvl

  альянсы:
    - Поле игрока: allianceName (строка 2–20 символов или null)
    - Создать / вступить / выйти из альянса по названию (без одобрения)
    - При атаке: сила защиты цели = сумма (fleet + defense) × 0.6 по всем онлайн-игрокам того же альянса
    - Отображение: HUD, под ником планеты на карте

  торговля:
    - Передача ресурсов другому игроку: выбор ника и суммы, списание у отправителя, зачисление получателю
    - Сообщение в чат о передаче

  лидерборд:
    - Топ-10 по уровню, по ресурсам, по победам (wins). wins увеличивается при уничтожении чужой планеты

  PvP:
    - Кнопка «Режим атаки» → клик по чужой планете → диалог выбора кол-ва флота
    - Флот летит к цели (120 px/сек, military бустит скорость)
    - Все видят летящие флоты на карте
    - Цель видит предупреждение о входящей атаке (красная рамка)
    - Условие победы: fleet × milBonus > сила_защиты_цели (один игрок или альянс)
    - Кулдаун атаки: 30 секунд
    - Победитель: крадёт 50% res, 70% посланного флота возвращается, планета цели уничтожается, +1 wins
    - Проигравший: весь посланный fleet теряется, defense цели -30%
    - При уничтожении: цель получает событие defeated с данными о бое → экран смерти

  миссии:
    - Серверная сущность missions[] — массив летящих объектов
    - Типы: attack (боевой флот), mine (шахтёр к астероиду), return (возврат с грузом)
    - Тик 50мс обновляет позиции, проверяет прибытие

  карта:
    - Динамический размер: базовый 4000×3000, +280×220 за каждого игрока
    - Максимум: 10000×7500
    - Автоматическое расширение при спавне, если нет места для минимальной дистанции
    - Сервер передаёт текущие mapW/mapH клиентам через state

  визуал (Canvas 2D):
    - Два canvas: основной + bloom (filter: blur(16px), mix-blend-mode: screen, opacity 0.35)
    - Параллакс-звёзды (3 слоя с разной скоростью, 200+150+100 звёзд)
    - 6 туманностей / небул (радиальные градиенты, случайный hue)
    - Анимированные кометы с хвостами (3 шт., перезапуск при выходе за карту)
    - Пульсация планет
    - Радиальный градиент + тень → псевдо-3D планета
    - Атмосфера (градиентный ореол)
    - Щит (пунктирный круг, видимость зависит от defense)
    - Кольца (lvl > 4)
    - Вращающиеся луны (по количеству lvl)
    - Орбитальный флот (точки/квадратики)
    - Летящие флоты с trail-эффектами (огненный хвост)
    - Шахтёры с жёлтым/зелёным trail
    - Частицы при взрывах (с bloom)
    - Мини-карта (200×150, мобильная 140×105 / 100×75) с планетами, астероидами, миссиями и рамкой обзора
    - Клик по мини-карте — перемещение камеры

  UI/UX:
    - Три экрана-оверлея: логин, экран смерти, игра
    - HUD с unicode-иконками (★ ◆ ✈ ○ ⚔ ☂), альянс, всплывающие подсказки (тултипы)
    - Панель улучшений с названиями, описаниями и ценой
    - Панель «Как играть» для новичков (onboarding — можно скрыть, запоминает в localStorage)
    - Кнопка помощи «?» с полной справкой (разделы: Как играть, Ресурсы и показатели)
    - Кнопки: Режим атаки, Альянс, Торговля, Топ-10, Самоуничтожение
    - Панели: альянс (создать/вступить/выйти), торговля (игрок + сумма), лидерборд (топ-10 по lvl/res/wins)
    - Экран смерти: кто убил, потерянные ресурсы/уровень/флот, поле ника для респавна
    - Переключатель языка RU/EN (сохраняется в localStorage)

  навигация:
    - Space — центрировать камеру на своей планете
    - ПКМ + перетаскивание — перемещение камеры
    - Колёсико мыши — зум камеры (0.35×–2×), зум к точке под курсором
    - Автоцентрирование при входе в игру
    - Escape — отмена режима атаки / закрытие диалогов и панелей

  мобильная_версия:
    - Адаптивная вёрстка (@media max-width: 768px и 480px)
    - Тач-события (touch-action: none, -webkit-tap-highlight-color: transparent)
    - safe-area-inset поддержка (для вырезов iPhone)
    - Компактный HUD с переносом строк
    - Скрытие keyboard shortcuts на мобильных
    - Уменьшенные панели, мини-карта, чат
    - Минимальный размер кнопок 44px для удобного нажатия

  персистентность (Redis):
    - ioredis ^5.4.1, поддержка REDIS_URL и REDIS_HOST/REDIS_PORT
    - Ключи: player:{nick} (JSON), players:nicks (Set)
    - Загрузка всех игроков при старте сервера
    - Сохранение при каждом изменении (upgrade, buy, attack, trade и т.д.)
    - Удаление при самоуничтожении и уничтожении в бою
    - Docker: redis:7-alpine с appendonly yes и persistent volume

# ── Правила разработки (обязательно для всех) ────────────────
rules:
  - Всё клиентское — в одном файле index.html (без сборщиков)
  - Никакого WebGL / Three.js / React / Vue
  - Основной ключ игрока — nick (строка)
  - socket.id используется только временно (для текущего соединения)
  - При disconnect → не удалять игрока сразу (только обновлять last_seen)
  - Самоуничтожение → полное удаление записи по нику
  - Комментарии в коде — преимущественно на русском
  - Новые механики сначала описывать здесь в .agent, потом реализовывать

# ── Ближайшие улучшения (приоритет 2026) ─────────────────────
todo-high:
  - ~~Персистентность: Redis подключён~~
  - Защита от ник-сквоттинга (timeout оффлайн > 30 мин → можно перехватить)
  - ~~Альянсы (суммирование флота при защите; create/join/leave)~~
  - ~~Торговля ресурсами между игроками~~
  - ~~Лидерборд (топ-10 по lvl / res / побед)~~

todo-medium:
  - Глобальный чат (ввод сообщений)
  - Названия планет (отдельное поле)
  - Звуковые эффекты (Web Audio API или Howler)
  - ~~Zoom камеры (колёсико мыши)~~
  - ~~Мобильная вёрстка (адаптивные breakpoints, тач, safe-area)~~
  - ~~Справка для новых игроков (onboarding + панель помощи)~~
  - ~~Авторасширение карты от количества игроков~~
  - ~~Локализация RU/EN~~
  - ~~Визуал: bloom, параллакс-звёзды, туманности, кометы, атмосфера, кольца, луны~~

# ── Конец конфига ────────────────────────────────────────────

<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Space Chaos</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #0a0a1a;
    color: #ddd;
    font-family: 'Segoe UI', Tahoma, sans-serif;
    overflow: hidden;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
  }

  /* ‚ïê‚ïê‚ïê –û–±—â–∏–µ —ç–∫—Ä–∞–Ω—ã-–æ–≤–µ—Ä–ª–µ–∏ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  .overlay {
    position: fixed; inset: 0;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    background: radial-gradient(ellipse at center, #111133 0%, #0a0a1a 70%);
    z-index: 100;
  }
  .overlay h1 {
    font-size: 48px; margin-bottom: 6px;
    background: linear-gradient(90deg, #ff6fd8, #3813c2);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .overlay .sub { color: #888; margin-bottom: 20px; font-size: 14px; }
  .overlay input[type=text] {
    width: 280px; padding: 12px 16px;
    border: 2px solid #333; border-radius: 8px;
    background: #151528; color: #fff;
    font-size: 18px; text-align: center;
    outline: none; transition: border-color .2s;
  }
  .overlay input[type=text]:focus { border-color: #7c4dff; }
  .overlay .big-btn {
    margin-top: 12px; padding: 10px 40px;
    border: none; border-radius: 8px;
    background: linear-gradient(135deg, #7c4dff, #448aff);
    color: #fff; font-size: 16px; cursor: pointer;
    transition: opacity .2s;
  }
  .overlay .big-btn:hover { opacity: .85; }
  .overlay .error { margin-top: 8px; color: #ff5252; font-size: 13px; min-height: 18px; }

  /* ‚ïê‚ïê‚ïê –≠–∫—Ä–∞–Ω –ø–æ—Ä–∞–∂–µ–Ω–∏—è ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  #death-screen { display: none; }
  #death-screen h1 {
    background: linear-gradient(90deg, #ff1744, #ff6d00);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .death-stats {
    margin: 12px 0 20px;
    padding: 14px 24px;
    background: rgba(255,23,68,.08);
    border: 1px solid rgba(255,23,68,.2);
    border-radius: 8px;
    font-size: 14px; line-height: 1.8;
    text-align: center;
  }
  .death-stats .killer { color: #ff5252; font-weight: bold; font-size: 16px; }
  .death-stats .stat-line { color: #aaa; }
  .death-stats .stat-line b { color: #fff; }

  /* ‚ïê‚ïê‚ïê Canvas ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  #game-screen { display: none; }
  #canvas-main { display: block; cursor: crosshair; position: relative; z-index: 1; touch-action: none; }
  #canvas-bloom {
    position: fixed; inset: 0; z-index: 0;
    pointer-events: none;
    filter: blur(16px) brightness(1.5);
    mix-blend-mode: screen;
    opacity: 0.35;
  }

  /* ‚ïê‚ïê‚ïê HUD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  #hud {
    position: fixed; top: 0; left: 0; right: 0;
    display: flex; align-items: center; gap: 0;
    padding: 0 8px;
    background: rgba(10,10,26,.92);
    backdrop-filter: blur(6px);
    border-bottom: 1px solid #222;
    z-index: 10; font-size: 13px;
    height: 38px;
  }
  #hud .nick-label {
    font-weight: bold; color: #7c4dff; font-size: 14px;
    padding: 0 12px 0 4px;
    border-right: 1px solid #333;
    margin-right: 4px;
  }
  .hud-item {
    display: flex; align-items: center; gap: 4px;
    padding: 4px 10px;
    border-right: 1px solid rgba(255,255,255,.06);
    cursor: default;
    position: relative;
  }
  .hud-item:last-child { border-right: none; }
  .hud-icon { font-size: 14px; opacity: .7; }
  .hud-val { color: #fff; font-weight: bold; font-size: 13px; }
  .hud-item .hud-label { color: #777; font-size: 10px; margin-left: 2px; }

  /* –¢—É–ª—Ç–∏–ø—ã –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
  .hud-item .tooltip {
    display: none;
    position: absolute; top: 100%; left: 50%;
    transform: translateX(-50%);
    padding: 6px 10px; margin-top: 6px;
    background: rgba(20,20,40,.95);
    border: 1px solid #444; border-radius: 6px;
    font-size: 11px; color: #ccc;
    white-space: nowrap; z-index: 30;
    pointer-events: none;
  }
  .hud-item:hover .tooltip { display: block; }

  .hud-cd {
    color: #ff5252; font-weight: bold; font-size: 12px;
    padding: 4px 8px;
  }
  .hud-protected {
    color: #66bb6a; font-weight: bold; font-size: 11px;
    padding: 4px 8px;
    animation: protPulse 2s infinite;
  }
  @keyframes protPulse {
    0%,100% { opacity: 1; }
    50% { opacity: .5; }
  }

  /* ‚ïê‚ïê‚ïê –ü–∞–Ω–µ–ª—å —É–ª—É—á—à–µ–Ω–∏–π (—Å–ª–µ–≤–∞) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  #upgrade-panel {
    position: fixed; left: 10px; top: 50%;
    transform: translateY(-50%);
    display: flex; flex-direction: column; gap: 5px;
    z-index: 10; width: 170px;
  }
  .upg-section-title {
    font-size: 9px; color: #666; text-transform: uppercase;
    letter-spacing: 1px; padding: 4px 0 0 4px;
  }
  .upg-btn {
    padding: 7px 10px;
    border: 1px solid #2a2a3a; border-radius: 6px;
    background: rgba(18,18,36,.94);
    color: #bbb; font-size: 11px;
    cursor: pointer; transition: all .15s;
    text-align: left;
    display: flex; flex-direction: column; gap: 2px;
  }
  .upg-btn:hover { background: #1e1e3e; border-color: #555; color: #fff; }
  .upg-btn:active { transform: scale(.97); }
  .upg-top { display: flex; align-items: center; gap: 6px; }
  .upg-icon { font-size: 15px; }
  .upg-name { font-weight: bold; font-size: 12px; }
  .upg-desc { font-size: 9px; color: #666; line-height: 1.3; }
  .upg-cost { font-size: 10px; color: #fdd835; margin-top: 1px; }
  .upg-btn.eco .upg-name { color: #66bb6a; }
  .upg-btn.mil .upg-name { color: #ef5350; }
  .upg-btn.fort .upg-name { color: #4dd0e1; }
  .upg-sep { border: none; border-top: 1px solid #222; margin: 2px 0; }

  /* –ö–Ω–æ–ø–∫–∞-—Ç–æ–≥–≥–ª –ø–∞–Ω–µ–ª–∏ —É–ª—É—á—à–µ–Ω–∏–π (—Ç–æ–ª—å–∫–æ –º–æ–±–∏–ª—å–Ω–∞—è) */
  #upg-toggle {
    display: none;
    position: fixed; left: 6px; z-index: 11;
    width: 40px; height: 40px;
    border: 1px solid #333; border-radius: 8px;
    background: rgba(18,18,36,.94);
    color: #7c4dff; font-size: 20px; font-weight: bold;
    cursor: pointer;
    align-items: center; justify-content: center;
    transition: all .15s;
  }
  #upg-toggle:hover { background: rgba(124,77,255,.2); border-color: #7c4dff; }
  #upg-toggle.active { background: rgba(124,77,255,.3); border-color: #7c4dff; }

  /* ‚ïê‚ïê‚ïê –ö–Ω–æ–ø–∫–∏ –≤–Ω–∏–∑—É ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  #actions {
    position: fixed; bottom: 12px; left: 50%;
    transform: translateX(-50%);
    display: flex; gap: 6px; z-index: 10;
  }
  .action-btn {
    padding: 7px 14px;
    border: 1px solid #333; border-radius: 6px;
    background: rgba(20,20,40,.92);
    color: #ccc; font-size: 12px;
    cursor: pointer; transition: all .15s;
    display: flex; align-items: center; gap: 5px;
  }
  .action-btn:hover { background: #222; border-color: #7c4dff; color: #fff; }
  .action-btn .key {
    background: #333; padding: 1px 5px; border-radius: 3px;
    font-size: 10px; color: #888;
  }
  .action-btn.danger { border-color: #5a2020; }
  .action-btn.danger:hover { background: #3a1111; color: #ff5252; border-color: #ff5252; }

  /* ‚ïê‚ïê‚ïê –ß–∞—Ç ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  #chat-box {
    position: fixed; bottom: 50px; left: 10px;
    width: 300px; max-height: 140px;
    overflow-y: auto; z-index: 10;
    font-size: 11px; color: #aaa;
    pointer-events: none;
    scrollbar-width: none;           /* Firefox */
    -ms-overflow-style: none;        /* IE/Edge */
  }
  #chat-box::-webkit-scrollbar { display: none; }  /* Chrome/Safari */
  #chat-box div { margin-bottom: 2px; opacity: .8; }
  #chat-box .from { color: #7c4dff; font-weight: bold; }

  /* –ö–Ω–æ–ø–∫–∞ —Å–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞ (—Ç–æ–ª—å–∫–æ –º–æ–±–∏–ª—å–Ω–∞—è) */
  #chat-toggle {
    display: none;
    position: fixed; z-index: 11;
    width: 28px; height: 28px;
    border: 1px solid #333; border-radius: 6px;
    background: rgba(18,18,36,.92);
    color: #888; font-size: 14px;
    cursor: pointer;
    align-items: center; justify-content: center;
    transition: all .15s;
  }
  #chat-toggle:hover { background: rgba(124,77,255,.2); color: #b388ff; }

  /* ‚ïê‚ïê‚ïê –ú–∏–Ω–∏-–∫–∞—Ä—Ç–∞ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  #minimap {
    position: fixed; right: 10px; bottom: 10px;
    width: 200px; height: 150px;
    border: 1px solid #333; border-radius: 6px;
    background: rgba(10,10,26,.85);
    z-index: 10;
  }

  /* ‚ïê‚ïê‚ïê –ü–æ–¥—Å–∫–∞–∑–∫–∏ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  #attack-hint {
    position: fixed; top: 46px; left: 50%;
    transform: translateX(-50%);
    padding: 6px 18px; border-radius: 6px;
    background: rgba(255,82,82,.88);
    color: #fff; font-size: 12px;
    display: none; z-index: 20;
    animation: hintPulse 2s infinite;
  }
  @keyframes hintPulse {
    0%,100% { box-shadow: 0 0 0 0 rgba(255,82,82,.4); }
    50% { box-shadow: 0 0 0 8px rgba(255,82,82,0); }
  }
  #info-toast {
    position: fixed; top: 46px; left: 50%;
    transform: translateX(-50%);
    padding: 6px 18px; border-radius: 6px;
    background: rgba(33,150,243,.88);
    color: #fff; font-size: 12px;
    display: none; z-index: 20;
  }

  /* ‚ïê‚ïê‚ïê –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –≤—Ö–æ–¥—è—â–µ–π –∞—Ç–∞–∫–µ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  #incoming-warning {
    position: fixed; inset: 0;
    border: 4px solid transparent;
    pointer-events: none; z-index: 15;
  }
  #incoming-warning.active { animation: warningPulse 1s infinite; }
  @keyframes warningPulse {
    0%,100% { border-color: rgba(255,30,30,0); }
    50% { border-color: rgba(255,30,30,.5); }
  }

  /* ‚ïê‚ïê‚ïê –î–∏–∞–ª–æ–≥ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–ª–æ—Ç–∞ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  #fleet-dialog {
    position: fixed; top: 50%; left: 50%;
    transform: translate(-50%,-50%);
    padding: 22px 30px; border-radius: 12px;
    background: rgba(15,15,35,.97);
    border: 1px solid #444;
    z-index: 50; display: none;
    text-align: center; min-width: 260px;
  }
  #fleet-dialog h3 { color: #ef5350; margin-bottom: 4px; font-size: 15px; }
  #fleet-dialog .target-name { color: #fff; font-size: 14px; margin-bottom: 12px; }
  #fleet-dialog input {
    width: 140px; padding: 8px 10px;
    border: 1px solid #555; border-radius: 6px;
    background: #1a1a2e; color: #fff;
    font-size: 18px; text-align: center; outline: none;
  }
  #fleet-dialog .avail { font-size: 11px; color: #888; margin-top: 4px; }
  #fleet-dialog .btns { margin-top: 14px; display: flex; gap: 8px; justify-content: center; }
  #fleet-dialog button {
    padding: 7px 18px; border: none; border-radius: 6px;
    cursor: pointer; font-size: 13px; transition: opacity .15s;
  }
  #fleet-dialog button:hover { opacity: .85; }
  #fleet-dialog .send { background: #ef5350; color: #fff; }
  #fleet-dialog .cancel { background: #333; color: #aaa; }

  /* ‚ïê‚ïê‚ïê –ê–ª—å—è–Ω—Å / –¢–æ—Ä–≥–æ–≤–ª—è / –õ–∏–¥–µ—Ä–±–æ—Ä–¥ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  .panel-overlay {
    position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    padding: 18px 24px; border-radius: 12px;
    background: rgba(15,15,35,.97);
    border: 1px solid #444;
    z-index: 50; display: none;
    min-width: 280px; max-width: 420px;
  }
  .panel-overlay h3 { font-size: 14px; color: #b388ff; margin-bottom: 10px; }
  .panel-overlay input, .panel-overlay select {
    width: 100%; padding: 8px 10px; margin-bottom: 8px;
    border: 1px solid #555; border-radius: 6px;
    background: #1a1a2e; color: #fff; font-size: 13px;
  }
  .panel-overlay .row { display: flex; gap: 8px; margin-top: 10px; }
  .panel-overlay button {
    padding: 7px 14px; border: none; border-radius: 6px;
    cursor: pointer; font-size: 12px; flex: 1;
  }
  .panel-overlay .btn-ok { background: #7c4dff; color: #fff; }
  .panel-overlay .btn-cancel { background: #333; color: #aaa; }
  #alliance-panel .current { font-size: 11px; color: #888; margin-bottom: 8px; }
  #leaderboard-panel {
    max-height: 70vh; overflow-y: auto;
    display: grid; grid-template-columns: 1fr 1fr 1fr;
    gap: 12px; min-width: 360px;
  }
  #leaderboard-panel .col { font-size: 11px; }
  #leaderboard-panel .col h4 { font-size: 11px; color: #666; margin-bottom: 6px; text-transform: uppercase; }
  #leaderboard-panel .col .row { padding: 3px 0; border-bottom: 1px solid #222; display: flex; justify-content: space-between; }
  #leaderboard-panel .col .row .nick { color: #ccc; }
  #leaderboard-panel .col .row .val { color: #fdd835; font-weight: bold; }

  /* ‚ïê‚ïê‚ïê –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –Ω–æ–≤–∏—á–∫–∞ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  #onboarding {
    position: fixed; bottom: 50px; right: 220px;
    width: 220px; padding: 12px 14px;
    background: rgba(15,15,35,.94);
    border: 1px solid #333; border-radius: 8px;
    font-size: 11px; color: #aaa; line-height: 1.5;
    z-index: 10; display: none;
  }
  #onboarding .title { color: #7c4dff; font-weight: bold; font-size: 12px; margin-bottom: 4px; }
  #onboarding .close-tip {
    position: absolute; top: 4px; right: 8px;
    cursor: pointer; color: #666; font-size: 14px;
  }

  /* ‚ïê‚ïê‚ïê –ö–Ω–æ–ø–∫–∞ –ø–æ–º–æ—â–∏ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  #help-btn {
    position: fixed; top: 8px; right: 95px;
    z-index: 200;
    width: 32px; height: 28px;
    border: 1px solid #333; border-radius: 6px;
    background: rgba(18,18,36,.92);
    color: #7c4dff; font-size: 16px; font-weight: bold;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: all .15s;
  }
  #help-btn:hover { background: rgba(124,77,255,.2); border-color: #7c4dff; color: #b388ff; }

  /* ‚ïê‚ïê‚ïê –ü–∞–Ω–µ–ª—å –ø–æ–º–æ—â–∏ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  #help-panel {
    position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 90%; max-width: 440px; max-height: 85vh;
    padding: 20px 24px; border-radius: 12px;
    background: rgba(15,15,35,.98);
    border: 1px solid #444;
    z-index: 110; display: none;
    overflow-y: auto;
  }
  #help-panel h3 { font-size: 15px; color: #b388ff; margin-bottom: 12px; }
  #help-panel .help-section { margin-bottom: 16px; }
  #help-panel .help-section-title { font-size: 12px; color: #888; margin-bottom: 6px; text-transform: uppercase; }
  #help-panel .help-section p, #help-panel .help-section ul { font-size: 12px; color: #bbb; line-height: 1.6; margin: 0 0 6px 0; }
  #help-panel .help-section ul { padding-left: 18px; }
  #help-panel .help-section li { margin-bottom: 4px; }
  #help-panel .help-close { margin-top: 14px; padding: 8px 24px; width: 100%; border: none; border-radius: 6px; background: #333; color: #aaa; cursor: pointer; font-size: 13px; }
  #help-panel .help-close:hover { background: #444; color: #fff; }

  /* ‚ïê‚ïê‚ïê –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —è–∑—ã–∫–∞ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  #lang-toggle {
    position: fixed; top: 8px; right: 10px;
    z-index: 200;
    display: flex; align-items: center;
    background: rgba(18,18,36,.92);
    border: 1px solid #333; border-radius: 6px;
    overflow: hidden; cursor: pointer;
    font-size: 12px; font-weight: bold;
  }
  #lang-toggle .lang-opt {
    padding: 5px 10px;
    color: #666; transition: all .15s;
  }
  #lang-toggle .lang-opt.active {
    background: rgba(124,77,255,.25);
    color: #b388ff;
  }
  #lang-toggle .lang-opt:hover:not(.active) { color: #aaa; }

  /* ‚ïê‚ïê‚ïê –ú–æ–±–∏–ª—å–Ω–∞—è –≤—ë—Ä—Å—Ç–∫–∞ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  @media (max-width: 768px) {
    .overlay h1 { font-size: 32px; }
    .overlay .sub { font-size: 12px; margin-bottom: 14px; }
    .overlay input[type=text] { width: 90%; max-width: 280px; padding: 12px 14px; font-size: 16px; }
    .overlay .big-btn { padding: 12px 32px; font-size: 15px; }
    .death-stats { padding: 12px 16px; font-size: 13px; }
    .death-stats .killer { font-size: 14px; }

    #hud {
      flex-wrap: wrap; height: auto; min-height: 38px; padding: 6px 6px 8px;
      gap: 2px 0;
      padding-top: max(6px, env(safe-area-inset-top));
    }
    #hud .nick-label { font-size: 12px; padding: 0 8px 0 2px; }
    .hud-item { padding: 4px 6px; font-size: 11px; }
    .hud-icon { font-size: 12px; }
    .hud-val { font-size: 12px; }
    .hud-item .hud-label { font-size: 9px; }
    .hud-cd { font-size: 11px; padding: 4px 6px; }

    #upg-toggle {
      display: flex;
      bottom: max(120px, calc(env(safe-area-inset-bottom) + 114px));
    }

    #upgrade-panel {
      left: 6px; width: 150px;
      top: auto; bottom: max(166px, calc(env(safe-area-inset-bottom) + 160px));
      transform: none;
      gap: 4px;
      display: none;
    }
    #upgrade-panel.mobile-open { display: flex; }
    .upg-btn { padding: 6px 8px; font-size: 10px; }
    .upg-name { font-size: 11px; }
    .upg-desc { font-size: 8px; }
    .upg-cost { font-size: 9px; }

    #actions {
      bottom: max(8px, env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%);
      flex-wrap: wrap; justify-content: center; gap: 6px;
      max-width: 100%; padding: 0 8px;
    }
    .action-btn { padding: 10px 12px; font-size: 11px; min-height: 44px; }
    .action-btn .key { display: none; }

    #chat-box {
      width: calc(100% - 20px); max-width: 280px;
      max-height: 100px; bottom: 60px;
      font-size: 10px;
    }
    #chat-box.hidden { display: none; }
    #chat-toggle {
      display: flex;
      left: 10px; bottom: max(60px, calc(env(safe-area-inset-bottom) + 54px));
    }

    #minimap {
      width: 140px; height: 105px;
      right: max(6px, env(safe-area-inset-right));
      bottom: max(6px, env(safe-area-inset-bottom));
    }

    #attack-hint, #info-toast {
      top: max(46px, env(safe-area-inset-top, 0px));
      font-size: 11px; padding: 6px 12px;
      max-width: 90%;
    }

    #help-btn { top: max(8px, env(safe-area-inset-top, 0px)); right: 80px; width: 36px; height: 32px; font-size: 18px; }
    #lang-toggle { top: max(8px, env(safe-area-inset-top, 0px)); font-size: 11px; }
    #lang-toggle .lang-opt { padding: 6px 8px; }

    #help-panel { width: 94%; padding: 16px; max-height: 88vh; }
    #help-panel .help-section p, #help-panel .help-section ul { font-size: 11px; }
    .panel-overlay { width: 94%; min-width: 0; padding: 14px 16px; }
    #leaderboard-panel { grid-template-columns: 1fr; min-width: 0; gap: 10px; }
    #fleet-dialog { min-width: 0; width: 92%; padding: 16px 20px; }
    #fleet-dialog input { width: 100%; max-width: 140px; }
    #fleet-dialog .btns { flex-wrap: wrap; justify-content: center; }

    #onboarding {
      width: calc(100% - 24px); max-width: 280px;
      bottom: 70px; right: auto; left: 50%; transform: translateX(-50%);
      padding: 12px 14px; font-size: 11px;
    }
  }

  @media (max-width: 480px) {
    .overlay h1 { font-size: 26px; }
    .overlay input[type=text] { font-size: 16px; }

    #hud .nick-label { max-width: 60px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .hud-item .hud-label { display: none; }

    #upgrade-panel { width: 130px; bottom: max(158px, calc(env(safe-area-inset-bottom) + 152px)); }
    .upg-section-title { font-size: 8px; }
    .upg-btn { padding: 6px 6px; }
    .upg-desc { display: none; }
    #upg-toggle { bottom: max(114px, calc(env(safe-area-inset-bottom) + 108px)); }

    #actions { bottom: max(6px, env(safe-area-inset-bottom)); }
    .action-btn { padding: 10px 10px; font-size: 10px; min-height: 44px; }
    .action-btn span:not(.key) { max-width: 72px; overflow: hidden; text-overflow: ellipsis; }

    #chat-box { max-height: 80px; font-size: 9px; }
    #minimap { width: 100px; height: 75px; right: max(4px, env(safe-area-inset-right)); bottom: max(4px, env(safe-area-inset-bottom)); }

    #help-btn { right: 68px; width: 34px; height: 30px; }
    #lang-toggle .lang-opt { padding: 6px 6px; }

    .panel-overlay .row { flex-wrap: wrap; }
    .panel-overlay button { min-width: 0; }
    #alliance-panel .row button, #trade-panel .row button { flex: 1 1 45%; }
  }
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê –ö–Ω–æ–ø–∫–∞ –ø–æ–º–æ—â–∏ ‚ïê‚ïê‚ïê -->
<button type="button" id="help-btn" title="–ü–æ–º–æ—â—å">?</button>
<!-- ‚ïê‚ïê‚ïê –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —è–∑—ã–∫–∞ ‚ïê‚ïê‚ïê -->
<div id="lang-toggle">
  <span class="lang-opt active" data-lang="ru">RU</span>
  <span class="lang-opt" data-lang="en">EN</span>
</div>

<!-- ‚ïê‚ïê‚ïê –ü–∞–Ω–µ–ª—å –ø–æ–º–æ—â–∏ (–¥–æ—Å—Ç—É–ø–Ω–∞ —Å –ª—é–±–æ–≥–æ —ç–∫—Ä–∞–Ω–∞) ‚ïê‚ïê‚ïê -->
<div id="help-panel">
  <h3 id="help-title">–ü–æ–º–æ—â—å</h3>
  <div class="help-section">
    <div class="help-section-title" id="help-how-title">–ö–∞–∫ –∏–≥—Ä–∞—Ç—å</div>
    <div id="help-how-content"></div>
  </div>
  <div class="help-section">
    <div class="help-section-title" id="help-res-title">–†–µ—Å—É—Ä—Å—ã –∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</div>
    <div id="help-res-content"></div>
  </div>
  <button type="button" class="help-close" id="help-close">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>

<!-- ‚ïê‚ïê‚ïê –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ ‚ïê‚ïê‚ïê -->
<div class="overlay" id="login-screen">
  <h1 id="login-title">Space Chaos</h1>
  <p class="sub" id="login-sub">–ú–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –∫–æ—Å–º–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è</p>
  <input id="nick-input" type="text" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º" maxlength="16" autofocus>
  <button class="big-btn" id="join-btn">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
  <div class="error" id="login-error"></div>
</div>

<!-- ‚ïê‚ïê‚ïê –≠–∫—Ä–∞–Ω –ø–æ—Ä–∞–∂–µ–Ω–∏—è / —Ä–µ—Å–ø–∞–≤–Ω–∞ ‚ïê‚ïê‚ïê -->
<div class="overlay" id="death-screen">
  <h1 id="death-title">–ü–ª–∞–Ω–µ—Ç–∞ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∞</h1>
  <div class="death-stats">
    <div class="killer" id="death-killer"></div>
    <div class="stat-line"><span id="death-res-label">–ü–æ—Ç–µ—Ä—è–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤:</span> <b id="death-res">0</b></div>
    <div class="stat-line"><span id="death-lvl-label">–£—Ä–æ–≤–µ–Ω—å –ø–ª–∞–Ω–µ—Ç—ã:</span> <b id="death-lvl">0</b></div>
    <div class="stat-line"><span id="death-fleet-label">–§–ª–æ—Ç:</span> <b id="death-fleet">0</b></div>
  </div>
  <input id="respawn-nick" type="text" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º" maxlength="16">
  <button class="big-btn" id="respawn-btn">–í–æ–∑—Ä–æ–¥–∏—Ç—å—Å—è</button>
  <div class="error" id="respawn-error"></div>
</div>

<!-- ‚ïê‚ïê‚ïê –ò–≥—Ä–æ–≤–æ–π —ç–∫—Ä–∞–Ω ‚ïê‚ïê‚ïê -->
<div id="game-screen">
  <canvas id="canvas-bloom"></canvas>
  <canvas id="canvas-main"></canvas>

  <!-- HUD -->
  <div id="hud">
    <div class="nick-label" id="hud-nick"></div>
    <div class="hud-item" id="hud-alliance-wrap" style="display:none">
      <span class="hud-icon">&#128101;</span>
      <span class="hud-val" id="hud-alliance">‚Äî</span>
    </div>

    <div class="hud-item">
      <span class="hud-icon">&#9733;</span>
      <span class="hud-val" id="hud-lvl">1</span>
      <span class="hud-label" id="lbl-lvl">—É—Ä.</span>
      <div class="tooltip" id="tip-lvl">–£—Ä–æ–≤–µ–Ω—å —ç–∫–æ–Ω–æ–º–∏–∫–∏. –ß–µ–º –≤—ã—à–µ, —Ç–µ–º –±–æ–ª—å—à–µ –¥–æ—Ö–æ–¥ —Ä–µ—Å—É—Ä—Å–æ–≤</div>
    </div>

    <div class="hud-item">
      <span class="hud-icon">&#9670;</span>
      <span class="hud-val" id="hud-res">0</span>
      <span class="hud-label" id="lbl-res">—Ä–µ—Å.</span>
      <div class="tooltip" id="tip-res">–†–µ—Å—É—Ä—Å—ã. –¢—Ä–∞—Ç—è—Ç—Å—è –Ω–∞ —É–ª—É—á—à–µ–Ω–∏—è, —Ñ–ª–æ—Ç –∏ –∑–∞—â–∏—Ç—É</div>
    </div>

    <div class="hud-item">
      <span class="hud-icon">&#9992;</span>
      <span class="hud-val" id="hud-fleet">0</span>
      <span class="hud-label" id="lbl-fleet">—Ñ–ª–æ—Ç</span>
      <div class="tooltip" id="tip-fleet">–ö–æ—Ä–∞–±–ª–∏ –¥–ª—è –∞—Ç–∞–∫–∏ –∏ –¥–æ–±—ã—á–∏ –∞—Å—Ç–µ—Ä–æ–∏–¥–æ–≤</div>
    </div>

    <div class="hud-item">
      <span class="hud-icon">&#9711;</span>
      <span class="hud-val" id="hud-def">0</span>
      <span class="hud-label" id="lbl-def">—â–∏—Ç</span>
      <div class="tooltip" id="tip-def">–ó–∞—â–∏—Ç–∞ –ø–ª–∞–Ω–µ—Ç—ã. –ü–æ–º–æ–≥–∞–µ—Ç –≤—ã—Å—Ç–æ—è—Ç—å –ø—Ä–∏ –∞—Ç–∞–∫–µ</div>
    </div>

    <div class="hud-item">
      <span class="hud-icon">&#9876;</span>
      <span class="hud-val" id="hud-mil">0</span>
      <span class="hud-label" id="lbl-mil">–≤–æ–µ–Ω.</span>
      <div class="tooltip" id="tip-mil">–í–æ–µ–Ω–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å: +5% —Å–∏–ª—ã –∞—Ç–∞–∫–∏, +10% —Å–∫–æ—Ä–æ—Å—Ç–∏ —Ñ–ª–æ—Ç–∞</div>
    </div>

    <div class="hud-item">
      <span class="hud-icon">&#9730;</span>
      <span class="hud-val" id="hud-fort">0</span>
      <span class="hud-label" id="lbl-fort">—Ñ–æ—Ä—Ç</span>
      <div class="tooltip" id="tip-fort">–§–æ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è: —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –º–∞–∫—Å. —â–∏—Ç –∏ –µ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ</div>
    </div>

    <div class="hud-cd" id="hud-cd" style="display:none">
      &#9201; <span id="hud-cd-val">0</span><span id="hud-cd-unit">—Å</span>
    </div>
    <div class="hud-protected" id="hud-protected" style="display:none">&#9752; –ü–æ–¥ –∑–∞—â–∏—Ç–æ–π</div>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞-—Ç–æ–≥–≥–ª –ø–∞–Ω–µ–ª–∏ —É–ª—É—á—à–µ–Ω–∏–π (–º–æ–±–∏–ª—å–Ω–∞—è) -->
  <button type="button" id="upg-toggle" title="–£–ª—É—á—à–µ–Ω–∏—è">&#9733;</button>
  <!-- –ü–∞–Ω–µ–ª—å —É–ª—É—á—à–µ–Ω–∏–π -->
  <div id="upgrade-panel">
    <div class="upg-section-title" id="upg-title">–£–ª—É—á—à–µ–Ω–∏—è</div>

    <button class="upg-btn eco" id="btn-upg-eco">
      <div class="upg-top"><span class="upg-icon">&#9733;</span><span class="upg-name" id="upg-eco-name">–≠–∫–æ–Ω–æ–º–∏–∫–∞</span></div>
      <div class="upg-desc" id="upg-eco-desc">+8 —Ä–µ—Å/—Å–µ–∫ –∑–∞ —É—Ä–æ–≤–µ–Ω—å</div>
      <div class="upg-cost" id="cost-eco"></div>
    </button>

    <button class="upg-btn mil" id="btn-upg-mil">
      <div class="upg-top"><span class="upg-icon">&#9876;</span><span class="upg-name" id="upg-mil-name">–í–æ–µ–Ω–Ω–æ–µ –¥–µ–ª–æ</span></div>
      <div class="upg-desc" id="upg-mil-desc">+5% —Å–∏–ª–∞, +10% —Å–∫–æ—Ä–æ—Å—Ç—å</div>
      <div class="upg-cost" id="cost-mil"></div>
    </button>

    <button class="upg-btn fort" id="btn-upg-fort">
      <div class="upg-top"><span class="upg-icon">&#9730;</span><span class="upg-name" id="upg-fort-name">–£–∫—Ä–µ–ø–ª–µ–Ω–∏–µ</span></div>
      <div class="upg-desc" id="upg-fort-desc">+10 –º–∞–∫—Å. —â–∏—Ç, +0.5 —Ä–µ–≥–µ–Ω</div>
      <div class="upg-cost" id="cost-fort"></div>
    </button>

    <hr class="upg-sep">
    <div class="upg-section-title" id="buy-title">–ü–æ–∫—É–ø–∫–∞</div>

    <button class="upg-btn" id="btn-fleet1">
      <div class="upg-top"><span class="upg-icon">&#9992;</span><span id="buy-f1">+1 –∫–æ—Ä–∞–±–ª—å</span></div>
      <div class="upg-cost" id="buy-f1-cost">10 —Ä–µ—Å.</div>
    </button>
    <button class="upg-btn" id="btn-fleet10">
      <div class="upg-top"><span class="upg-icon">&#9992;</span><span id="buy-f10">+10 –∫–æ—Ä–∞–±–ª–µ–π</span></div>
      <div class="upg-cost" id="buy-f10-cost">100 —Ä–µ—Å.</div>
    </button>
    <button class="upg-btn" id="btn-def5">
      <div class="upg-top"><span class="upg-icon">&#9711;</span><span id="buy-d5">+5 —â–∏—Ç</span></div>
      <div class="upg-cost" id="buy-d5-cost">75 —Ä–µ—Å.</div>
    </button>
  </div>

  <!-- –î–µ–π—Å—Ç–≤–∏—è -->
  <div id="actions">
    <button class="action-btn" id="btn-center"><span class="key">Space</span> <span id="act-center">–ú–æ—è –ø–ª–∞–Ω–µ—Ç–∞</span></button>
    <button class="action-btn" id="btn-attack-mode"><span class="key">Click</span> <span id="act-attack">–†–µ–∂–∏–º –∞—Ç–∞–∫–∏</span></button>
    <button class="action-btn" id="btn-alliance">&#128101; –ê–ª—å—è–Ω—Å</button>
    <button class="action-btn" id="btn-trade">&#128230; –¢–æ—Ä–≥–æ–≤–ª—è</button>
    <button class="action-btn" id="btn-leaderboard">&#127942; –¢–æ–ø-10</button>
    <button class="action-btn danger" id="btn-destruct"><span id="act-destruct">–°–∞–º–æ—É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ</span></button>
  </div>

  <button type="button" id="chat-toggle" title="–°–∫—Ä—ã—Ç—å/–ø–æ–∫–∞–∑–∞—Ç—å —á–∞—Ç">&#128172;</button>
  <div id="chat-box"></div>
  <canvas id="minimap" width="200" height="150"></canvas>
  <div id="attack-hint">&#9876; –ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ —á—É–∂–æ–π –ø–ª–∞–Ω–µ—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–ª–æ—Ç</div>
  <div id="info-toast"></div>
  <div id="incoming-warning"></div>

  <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –Ω–æ–≤–∏—á–∫–∞ -->
  <div id="onboarding">
    <span class="close-tip" id="close-onboarding">&#10005;</span>
    <div class="title" id="onb-title">–ö–∞–∫ –∏–≥—Ä–∞—Ç—å</div>
    <span id="onb-tips">&#9733; –£–ª—É—á—à–∞–π —ç–∫–æ–Ω–æ–º–∏–∫—É, —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–µ–µ –∫–æ–ø–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã<br>
    &#9992; –°—Ç—Ä–æ–π –∫–æ—Ä–∞–±–ª–∏ –¥–ª—è –∞—Ç–∞–∫ –∏ –¥–æ–±—ã—á–∏<br>
    &#9670; –ö–ª–∏–∫–∞–π –ø–æ –∞—Å—Ç–µ—Ä–æ–∏–¥–∞–º, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–æ–±—ã—Ç—á–∏–∫–∞<br>
    &#9876; –ö–ª–∏–∫–Ω–∏ —Å–≤–æ—é –ø–ª–∞–Ω–µ—Ç—É, –∑–∞—Ç–µ–º —á—É–∂—É—é ‚Äî –∞—Ç–∞–∫–∞!<br>
    &#9711; –ü–æ–∫—É–ø–∞–π —â–∏—Ç –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –≤—Ä–∞–≥–æ–≤<br>
    &#9730; –ö–∞—á–∞–π —É–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –¥–ª—è –∞–≤—Ç–æ-–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —â–∏—Ç–∞</span>
  </div>

  <!-- –ü–∞–Ω–µ–ª—å –∞–ª—å—è–Ω—Å–∞ -->
  <div class="panel-overlay" id="alliance-panel">
    <h3>&#128101; –ê–ª—å—è–Ω—Å</h3>
    <div class="current" id="alliance-current">–°–µ–π—á–∞—Å: –Ω–µ—Ç</div>
    <input type="text" id="alliance-name-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∞–ª—å—è–Ω—Å–∞ (2‚Äì20 —Å–∏–º–≤–æ–ª–æ–≤)" maxlength="20">
    <div class="row">
      <button class="btn-ok" id="alliance-create">–°–æ–∑–¥–∞—Ç—å</button>
      <button class="btn-ok" id="alliance-join">–í—Å—Ç—É–ø–∏—Ç—å</button>
      <button class="btn-cancel" id="alliance-leave">–í—ã–π—Ç–∏</button>
      <button class="btn-cancel" id="alliance-close">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
  <!-- –ü–∞–Ω–µ–ª—å —Ç–æ—Ä–≥–æ–≤–ª–∏ -->
  <div class="panel-overlay" id="trade-panel">
    <h3>&#128230; –ü–µ—Ä–µ–¥–∞—Ç—å —Ä–µ—Å—É—Ä—Å—ã</h3>
    <select id="trade-player-select"><option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞</option></select>
    <input type="number" id="trade-amount-input" min="1" placeholder="–°—É–º–º–∞ res">
    <div class="row">
      <button class="btn-ok" id="trade-send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <button class="btn-cancel" id="trade-close">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
  <!-- –õ–∏–¥–µ—Ä–±–æ—Ä–¥ -->
  <div class="panel-overlay" id="leaderboard-panel">
    <h3 style="grid-column:1/-1">&#127942; –¢–æ–ø-10</h3>
    <div class="col">
      <h4>–ü–æ —É—Ä–æ–≤–Ω—é</h4>
      <div id="leader-lvl"></div>
    </div>
    <div class="col">
      <h4>–ü–æ —Ä–µ—Å—É—Ä—Å–∞–º</h4>
      <div id="leader-res"></div>
    </div>
    <div class="col">
      <h4>–ü–æ –ø–æ–±–µ–¥–∞–º</h4>
      <div id="leader-wins"></div>
    </div>
    <button class="btn-cancel" id="leaderboard-close" style="grid-column:1/-1; margin-top:8px">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>

  <!-- –î–∏–∞–ª–æ–≥ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–ª–æ—Ç–∞ -->
  <div id="fleet-dialog">
    <h3 id="fd-title">&#9876; –ê—Ç–∞–∫–æ–≤–∞—Ç—å</h3>
    <div class="target-name" id="fleet-dialog-target"></div>
    <input id="fleet-count-input" type="number" min="1" placeholder="–ö–æ–ª-–≤–æ –∫–æ—Ä–∞–±–ª–µ–π">
    <div class="avail"><span id="fd-avail-label">–î–æ—Å—Ç—É–ø–Ω–æ:</span> <span id="fleet-avail">0</span> <span id="fd-ships-label">–∫–æ—Ä–∞–±–ª–µ–π</span></div>
    <div class="btns">
      <button class="send" id="fleet-send-btn"><span id="fd-send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span></button>
      <button class="send" id="fleet-all-btn"><span id="fd-all">–í–µ—Å—å —Ñ–ª–æ—Ç</span></button>
      <button class="cancel" id="fleet-cancel-btn"><span id="fd-cancel">–û—Ç–º–µ–Ω–∞</span></button>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ö–ª–∏–µ–Ω—Ç ‚Äî Space Chaos v0.7
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(() => {
  'use strict';

  // ‚îÄ‚îÄ DOM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const loginScreen   = document.getElementById('login-screen');
  const deathScreen   = document.getElementById('death-screen');
  const gameScreen    = document.getElementById('game-screen');
  const nickInput     = document.getElementById('nick-input');
  const joinBtn       = document.getElementById('join-btn');
  const loginError    = document.getElementById('login-error');

  const respawnNick   = document.getElementById('respawn-nick');
  const respawnBtn    = document.getElementById('respawn-btn');
  const respawnError  = document.getElementById('respawn-error');

  const canvas   = document.getElementById('canvas-main');
  const ctx      = canvas.getContext('2d');
  const bloomC   = document.getElementById('canvas-bloom');
  const bloomCtx = bloomC.getContext('2d');
  const mmCanvas = document.getElementById('minimap');
  const mmCtx    = mmCanvas.getContext('2d');

  const hudNick  = document.getElementById('hud-nick');
  const hudLvl   = document.getElementById('hud-lvl');
  const hudRes   = document.getElementById('hud-res');
  const hudFleet = document.getElementById('hud-fleet');
  const hudDef   = document.getElementById('hud-def');
  const hudMil   = document.getElementById('hud-mil');
  const hudFort  = document.getElementById('hud-fort');
  const hudCd    = document.getElementById('hud-cd');
  const hudCdVal = document.getElementById('hud-cd-val');
  const chatBox  = document.getElementById('chat-box');
  const attackHint  = document.getElementById('attack-hint');
  const infoToast   = document.getElementById('info-toast');
  const incomingWarn = document.getElementById('incoming-warning');
  const onboarding  = document.getElementById('onboarding');

  const fleetDialog     = document.getElementById('fleet-dialog');
  const fleetDialogTarget = document.getElementById('fleet-dialog-target');
  const fleetCountInput = document.getElementById('fleet-count-input');
  const fleetAvailSpan  = document.getElementById('fleet-avail');

  const alliancePanel = document.getElementById('alliance-panel');
  const allianceCurrent = document.getElementById('alliance-current');
  const allianceNameInput = document.getElementById('alliance-name-input');
  const tradePanel = document.getElementById('trade-panel');
  const tradePlayerSelect = document.getElementById('trade-player-select');
  const tradeAmountInput = document.getElementById('trade-amount-input');
  const leaderboardPanel = document.getElementById('leaderboard-panel');
  const hudAllianceWrap = document.getElementById('hud-alliance-wrap');
  const hudAlliance = document.getElementById('hud-alliance');

  // ‚îÄ‚îÄ –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è (RU/EN) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const L10N = {
    ru: {
      pageTitle: 'Space Chaos',
      loginTitle: 'Space Chaos',
      loginSub: '–ú–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –∫–æ—Å–º–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è',
      nickPlaceholder: '–í–∞—à –Ω–∏–∫–Ω–µ–π–º',
      joinBtn: '–ù–∞—á–∞—Ç—å –∏–≥—Ä—É',
      deathTitle: '–ü–ª–∞–Ω–µ—Ç–∞ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∞',
      deathResLabel: '–ü–æ—Ç–µ—Ä—è–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤:',
      deathLvlLabel: '–£—Ä–æ–≤–µ–Ω—å –ø–ª–∞–Ω–µ—Ç—ã:',
      deathFleetLabel: '–§–ª–æ—Ç:',
      deathKillerBy: '–£–Ω–∏—á—Ç–æ–∂–µ–Ω –∏–≥—Ä–æ–∫–æ–º {0}',
      respawnPlaceholder: '–í–∞—à –Ω–∏–∫–Ω–µ–π–º',
      respawnBtn: '–í–æ–∑—Ä–æ–¥–∏—Ç—å—Å—è',
      lblLvl: '—É—Ä.', lblRes: '—Ä–µ—Å.', lblFleet: '—Ñ–ª–æ—Ç', lblDef: '—â–∏—Ç', lblMil: '–≤–æ–µ–Ω.', lblFort: '—Ñ–æ—Ä—Ç',
      tipLvl: '–£—Ä–æ–≤–µ–Ω—å —ç–∫–æ–Ω–æ–º–∏–∫–∏. –ß–µ–º –≤—ã—à–µ, —Ç–µ–º –±–æ–ª—å—à–µ –¥–æ—Ö–æ–¥ —Ä–µ—Å—É—Ä—Å–æ–≤',
      tipRes: '–†–µ—Å—É—Ä—Å—ã. –¢—Ä–∞—Ç—è—Ç—Å—è –Ω–∞ —É–ª—É—á—à–µ–Ω–∏—è, —Ñ–ª–æ—Ç –∏ –∑–∞—â–∏—Ç—É',
      tipFleet: '–ö–æ—Ä–∞–±–ª–∏ –¥–ª—è –∞—Ç–∞–∫–∏ –∏ –¥–æ–±—ã—á–∏ –∞—Å—Ç–µ—Ä–æ–∏–¥–æ–≤',
      tipDef: '–ó–∞—â–∏—Ç–∞ –ø–ª–∞–Ω–µ—Ç—ã. –ü–æ–º–æ–≥–∞–µ—Ç –≤—ã—Å—Ç–æ—è—Ç—å –ø—Ä–∏ –∞—Ç–∞–∫–µ',
      tipMil: '–í–æ–µ–Ω–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å: +5% —Å–∏–ª—ã –∞—Ç–∞–∫–∏, +10% —Å–∫–æ—Ä–æ—Å—Ç–∏ —Ñ–ª–æ—Ç–∞',
      tipFort: '–§–æ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è: —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –º–∞–∫—Å. —â–∏—Ç –∏ –µ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ',
      resShort: '—Ä–µ—Å.',
      cdUnit: '—Å',
      upgTitle: '–£–ª—É—á—à–µ–Ω–∏—è', buyTitle: '–ü–æ–∫—É–ø–∫–∞',
      upgEcoName: '–≠–∫–æ–Ω–æ–º–∏–∫–∞', upgEcoDesc: '+8 —Ä–µ—Å/—Å–µ–∫ –∑–∞ —É—Ä–æ–≤–µ–Ω—å',
      upgMilName: '–í–æ–µ–Ω–Ω–æ–µ –¥–µ–ª–æ', upgMilDesc: '+5% —Å–∏–ª–∞, +10% —Å–∫–æ—Ä–æ—Å—Ç—å',
      upgFortName: '–£–∫—Ä–µ–ø–ª–µ–Ω–∏–µ', upgFortDesc: '+10 –º–∞–∫—Å. —â–∏—Ç, +0.5 —Ä–µ–≥–µ–Ω',
      buyF1: '+1 –∫–æ—Ä–∞–±–ª—å', buyF1Cost: '10 —Ä–µ—Å.', buyF10: '+10 –∫–æ—Ä–∞–±–ª–µ–π', buyF10Cost: '100 —Ä–µ—Å.',
      buyD5: '+5 —â–∏—Ç', buyD5Cost: '75 —Ä–µ—Å.',
      actCenter: '–ú–æ—è –ø–ª–∞–Ω–µ—Ç–∞', actAttack: '–†–µ–∂–∏–º –∞—Ç–∞–∫–∏', actDestruct: '–°–∞–º–æ—É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ',
      attackHint: '–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ —á—É–∂–æ–π –ø–ª–∞–Ω–µ—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–ª–æ—Ç',
      onbTitle: '–ö–∞–∫ –∏–≥—Ä–∞—Ç—å',
      onbTips: '‚òÖ –£–ª—É—á—à–∞–π —ç–∫–æ–Ω–æ–º–∏–∫—É, —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–µ–µ –∫–æ–ø–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã<br>‚úà –°—Ç—Ä–æ–π –∫–æ—Ä–∞–±–ª–∏ –¥–ª—è –∞—Ç–∞–∫ –∏ –¥–æ–±—ã—á–∏<br>‚óÜ –ö–ª–∏–∫–∞–π –ø–æ –∞—Å—Ç–µ—Ä–æ–∏–¥–∞–º, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–æ–±—ã—Ç—á–∏–∫–∞<br>‚öî –ö–ª–∏–∫–Ω–∏ —Å–≤–æ—é –ø–ª–∞–Ω–µ—Ç—É, –∑–∞—Ç–µ–º —á—É–∂—É—é ‚Äî –∞—Ç–∞–∫–∞!<br>‚òÇ –ü–æ–∫—É–ø–∞–π —â–∏—Ç –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –≤—Ä–∞–≥–æ–≤<br>‚òÄ –ö–∞—á–∞–π —É–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –¥–ª—è –∞–≤—Ç–æ-–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —â–∏—Ç–∞',
      fdTitle: '‚öî –ê—Ç–∞–∫–æ–≤–∞—Ç—å', fdAvailLabel: '–î–æ—Å—Ç—É–ø–Ω–æ:', fdShipsLabel: '–∫–æ—Ä–∞–±–ª–µ–π',
      fdSend: '–û—Ç–ø—Ä–∞–≤–∏—Ç—å', fdAll: '–í–µ—Å—å —Ñ–ª–æ—Ç', fdCancel: '–û—Ç–º–µ–Ω–∞',
      fleetCountPlaceholder: '–ö–æ–ª-–≤–æ –∫–æ—Ä–∞–±–ª–µ–π',
      confirmDestruct: '–°–∞–º–æ—É–Ω–∏—á—Ç–æ–∂–∏—Ç—å –ø–ª–∞–Ω–µ—Ç—É? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.',
      fleetSentToast: '–§–ª–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: {0} –∫–æ—Ä–∞–±–ª–µ–π, –ø—Ä–∏–±—ã—Ç–∏–µ ~{1}—Å',
      minerSentToast: '–î–æ–±—ã—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫ –∞—Å—Ç–µ—Ä–æ–∏–¥—É',
      helpTitle: '–ü–æ–º–æ—â—å',
      helpHowTitle: '–ö–∞–∫ –∏–≥—Ä–∞—Ç—å',
      helpHowContent: '<ul><li><b>‚òÖ –≠–∫–æ–Ω–æ–º–∏–∫–∞</b> ‚Äî —É–ª—É—á—à–∞–π —É—Ä–æ–≤–µ–Ω—å, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å –±–æ–ª—å—à–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É</li><li><b>‚úà –ö–æ—Ä–∞–±–ª–∏</b> ‚Äî –ø–æ–∫—É–ø–∞–π –∑–∞ —Ä–µ—Å—É—Ä—Å—ã; –Ω—É–∂–Ω—ã –¥–ª—è –∞—Ç–∞–∫–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–æ–±—ã—Ç—á–∏–∫–∞ –Ω–∞ –∞—Å—Ç–µ—Ä–æ–∏–¥</li><li><b>‚óÜ –ê—Å—Ç–µ—Ä–æ–∏–¥—ã</b> ‚Äî –∫–ª–∏–∫–Ω–∏ –ø–æ –∞—Å—Ç–µ—Ä–æ–∏–¥—É: –æ–¥–∏–Ω –∫–æ—Ä–∞–±–ª—å –ø–æ–ª–µ—Ç–∏—Ç –¥–æ–±—ã–≤–∞—Ç—å —Ä–µ—Å—É—Ä—Å—ã –∏ –≤–µ—Ä–Ω—ë—Ç—Å—è —Å –≥—Ä—É–∑–æ–º</li><li><b>‚öî –ê—Ç–∞–∫–∞</b> ‚Äî –Ω–∞–∂–º–∏ ¬´–†–µ–∂–∏–º –∞—Ç–∞–∫–∏¬ª, –∫–ª–∏–∫–Ω–∏ —Å–≤–æ—é –ø–ª–∞–Ω–µ—Ç—É, –∑–∞—Ç–µ–º —á—É–∂—É—é –∏ –≤—ã–±–µ—Ä–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ—Ä–∞–±–ª–µ–π</li><li><b>‚òÇ –©–∏—Ç</b> ‚Äî –ø–æ–∫—É–ø–∞–π –∑–∞—â–∏—Ç—É, —á—Ç–æ–±—ã –≤—ã–¥–µ—Ä–∂–∞—Ç—å –∞—Ç–∞–∫—É –≤—Ä–∞–≥–∞</li><li><b>‚òÄ –£–∫—Ä–µ–ø–ª–µ–Ω–∏–µ</b> ‚Äî —É–ª—É—á—à–∞–π –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –º–∞–∫—Å. —â–∏—Ç–∞ –∏ –µ–≥–æ –∞–≤—Ç–æ-–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è</li><li><b>ü§ù –ê–ª—å—è–Ω—Å</b> ‚Äî —Å–æ–∑–¥–∞–π –∏–ª–∏ –≤—Å—Ç—É–ø–∏ –≤ –∞–ª—å—è–Ω—Å; –ø—Ä–∏ –∞—Ç–∞–∫–µ –Ω–∞ —Å–æ—é–∑–Ω–∏–∫–∞ –≤–∞—à –æ–±—â–∏–π —Ñ–ª–æ—Ç –∏ —â–∏—Ç —Å—á–∏—Ç–∞—é—Ç—Å—è –≤–º–µ—Å—Ç–µ</li><li><b>üì¶ –¢–æ—Ä–≥–æ–≤–ª—è</b> ‚Äî –ø–µ—Ä–µ–¥–∞–≤–∞–π —Ä–µ—Å—É—Ä—Å—ã –¥—Ä—É–≥–∏–º –∏–≥—Ä–æ–∫–∞–º</li><li><b>Space</b> ‚Äî —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞–º–µ—Ä—É –Ω–∞ —Å–≤–æ–µ–π –ø–ª–∞–Ω–µ—Ç–µ. <b>–ö–æ–ª—ë—Å–∏–∫–æ –º—ã—à–∏</b> ‚Äî –∑—É–º. <b>–ü–ö–ú</b> ‚Äî –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã</li></ul>',
      helpResTitle: '–†–µ—Å—É—Ä—Å—ã –∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏',
      helpResContent: '<p><b>‚óÜ –†–µ—Å—É—Ä—Å—ã (res)</b> ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è –≤–∞–ª—é—Ç–∞. –ü–æ–ª—É—á–∞–µ—à—å –∫–∞–∂–¥—ã–π —Å–µ–∫—É–Ω–¥—É –ø–æ —É—Ä–æ–≤–Ω—é —ç–∫–æ–Ω–æ–º–∏–∫–∏, —Å –∞—Å—Ç–µ—Ä–æ–∏–¥–æ–≤ –∏ –ø—Ä–∏ –ø–æ–±–µ–¥–µ –≤ –∞—Ç–∞–∫–µ (50% —Ä–µ—Å—É—Ä—Å–æ–≤ –≤—Ä–∞–≥–∞). –¢—Ä–∞—Ç—è—Ç—Å—è –Ω–∞ —É–ª—É—á—à–µ–Ω–∏—è, –∫–æ—Ä–∞–±–ª–∏ –∏ —â–∏—Ç.</p><p><b>‚òÖ –£—Ä–æ–≤–µ–Ω—å (lvl)</b> ‚Äî —É—Ä–æ–≤–µ–Ω—å —ç–∫–æ–Ω–æ–º–∏–∫–∏. –ß–µ–º –≤—ã—à–µ, —Ç–µ–º –±–æ–ª—å—à–µ res/—Å–µ–∫ (+8 –∑–∞ —É—Ä–æ–≤–µ–Ω—å).</p><p><b>‚úà –§–ª–æ—Ç</b> ‚Äî –∫–æ—Ä–∞–±–ª–∏. –ê—Ç–∞–∫—É—é—Ç –≤—Ä–∞–≥–æ–≤ –∏ –¥–æ–±—ã–≤–∞—é—Ç –∞—Å—Ç–µ—Ä–æ–∏–¥—ã (1 –∫–æ—Ä–∞–±–ª—å = 1 –¥–æ–±—ã—Ç—á–∏–∫). –ü–æ–∫—É–ø–∫–∞: 10 res –∑–∞ –∫–æ—Ä–∞–±–ª—å.</p><p><b>‚òÇ –©–∏—Ç (defense)</b> ‚Äî –∑–∞—â–∏—Ç–∞ –ø–ª–∞–Ω–µ—Ç—ã. –°–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è —Å —Ñ–ª–æ—Ç–æ–º –ø—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ –æ–±–æ—Ä–æ–Ω—ã. –ü–æ–∫—É–ø–∫–∞: 15 res –∑–∞ –µ–¥–∏–Ω–∏—Ü—É. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Å–∞–º –ø—Ä–∏ –ø—Ä–æ–∫–∞—á–∞–Ω–Ω–æ–º –£–∫—Ä–µ–ø–ª–µ–Ω–∏–∏.</p><p><b>‚öî –í–æ–µ–Ω–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å</b> ‚Äî –¥–∞—ë—Ç +5% —Å–∏–ª—ã –∞—Ç–∞–∫–∏ –∏ +10% —Å–∫–æ—Ä–æ—Å—Ç–∏ —Ñ–ª–æ—Ç–∞ –∑–∞ —É—Ä–æ–≤–µ–Ω—å.</p><p><b>‚òÄ –£–∫—Ä–µ–ø–ª–µ–Ω–∏–µ</b> ‚Äî —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –º–∞–∫—Å. —â–∏—Ç –∏ —Å–∫–æ—Ä–æ—Å—Ç—å –µ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.</p>',
      helpClose: '–ó–∞–∫—Ä—ã—Ç—å',
      helpBtnTitle: '–ü–æ–º–æ—â—å: –∫–∞–∫ –∏–≥—Ä–∞—Ç—å –∏ —á—Ç–æ –∑–Ω–∞—á–∞—Ç —Ä–µ—Å—É—Ä—Å—ã',
      protectedLabel: '–ü–æ–¥ –∑–∞—â–∏—Ç–æ–π',
      protectedAttackMsg: '–≠—Ç–æ—Ç –∏–≥—Ä–æ–∫ –ø–æ–¥ –∑–∞—â–∏—Ç–æ–π –Ω–æ–≤–∏—á–∫–∞!',
      protectedHud: '–ó–∞—â–∏—Ç–∞ –Ω–æ–≤–∏—á–∫–∞',
    },
    en: {
      pageTitle: 'Space Chaos',
      loginTitle: 'Space Chaos',
      loginSub: 'Multiplayer space strategy',
      nickPlaceholder: 'Your nickname',
      joinBtn: 'Start game',
      deathTitle: 'Planet destroyed',
      deathResLabel: 'Resources lost:',
      deathLvlLabel: 'Planet level:',
      deathFleetLabel: 'Fleet:',
      deathKillerBy: 'Destroyed by player {0}',
      respawnPlaceholder: 'Your nickname',
      respawnBtn: 'Respawn',
      lblLvl: 'lvl', lblRes: 'res', lblFleet: 'fleet', lblDef: 'shield', lblMil: 'mil', lblFort: 'fort',
      tipLvl: 'Economy level. Higher = more resource income',
      tipRes: 'Resources. Spent on upgrades, fleet and defense',
      tipFleet: 'Ships for attack and asteroid mining',
      tipDef: 'Planet defense. Helps survive attacks',
      tipMil: 'Military level: +5% attack, +10% fleet speed',
      tipFort: 'Fortification: +max shield and regeneration',
      resShort: 'res',
      cdUnit: 's',
      upgTitle: 'Upgrades', buyTitle: 'Purchase',
      upgEcoName: 'Economy', upgEcoDesc: '+8 res/sec per level',
      upgMilName: 'Military', upgMilDesc: '+5% power, +10% speed',
      upgFortName: 'Fortification', upgFortDesc: '+10 max shield, +0.5 regen',
      buyF1: '+1 ship', buyF1Cost: '10 res', buyF10: '+10 ships', buyF10Cost: '100 res',
      buyD5: '+5 shield', buyD5Cost: '75 res',
      actCenter: 'My planet', actAttack: 'Attack mode', actDestruct: 'Self-destruct',
      attackHint: 'Click on an enemy planet to send fleet',
      onbTitle: 'How to play',
      onbTips: '‚òÖ Upgrade economy to earn resources faster<br>‚úà Build ships for attacks and mining<br>‚óÜ Click asteroids to send a miner<br>‚öî Click your planet, then enemy ‚Äî attack!<br>‚òÇ Buy shield to defend from enemies<br>‚òÄ Upgrade fortification for shield regen',
      fdTitle: '‚öî Attack', fdAvailLabel: 'Available:', fdShipsLabel: 'ships',
      fdSend: 'Send', fdAll: 'All fleet', fdCancel: 'Cancel',
      fleetCountPlaceholder: 'Ship count',
      confirmDestruct: 'Self-destruct planet? All data will be lost.',
      fleetSentToast: 'Fleet sent: {0} ships, ETA ~{1}s',
      minerSentToast: 'Miner sent to asteroid',
      helpTitle: 'Help',
      helpHowTitle: 'How to play',
      helpHowContent: '<ul><li><b>‚òÖ Economy</b> ‚Äî upgrade level to earn more resources per second</li><li><b>‚úà Ships</b> ‚Äî buy with resources; used for attack and sending a miner to an asteroid</li><li><b>‚óÜ Asteroids</b> ‚Äî click an asteroid: one ship will mine it and return with cargo</li><li><b>‚öî Attack</b> ‚Äî press ¬´Attack mode¬ª, click your planet, then an enemy planet and choose ship count</li><li><b>‚òÇ Shield</b> ‚Äî buy defense to survive enemy attacks</li><li><b>‚òÄ Fortification</b> ‚Äî upgrade to increase max shield and its auto-regen</li><li><b>ü§ù Alliance</b> ‚Äî create or join an alliance; when attacked, your combined fleet and shield count together</li><li><b>üì¶ Trade</b> ‚Äî send resources to other players</li><li><b>Space</b> ‚Äî center camera on your planet. <b>Mouse wheel</b> ‚Äî zoom. <b>Right mouse</b> ‚Äî pan the map</li></ul>',
      helpResTitle: 'Resources and stats',
      helpResContent: '<p><b>‚óÜ Resources (res)</b> ‚Äî main currency. You get them every second from economy level, from asteroids, and by winning attacks (50% of enemy res). Spent on upgrades, ships, and shield.</p><p><b>‚òÖ Level (lvl)</b> ‚Äî economy level. Higher = more res/sec (+8 per level).</p><p><b>‚úà Fleet</b> ‚Äî ships. Used to attack and to mine asteroids (1 ship = 1 miner). Cost: 10 res per ship.</p><p><b>‚òÇ Shield (defense)</b> ‚Äî planet defense. Added to fleet when calculating defense. Cost: 15 res per unit. Regenerates with Fortification.</p><p><b>‚öî Military level</b> ‚Äî +5% attack power and +10% fleet speed per level.</p><p><b>‚òÄ Fortification</b> ‚Äî increases max shield and its regeneration rate.</p>',
      helpClose: 'Close',
      helpBtnTitle: 'Help: how to play and what resources mean',
      protectedLabel: 'Protected',
      protectedAttackMsg: 'This player is under newbie protection!',
      protectedHud: 'Newbie shield',
    },
  };

  let currentLang = localStorage.getItem('planetLang') || 'ru';
  function t(key, ...args) {
    const s = (L10N[currentLang] && L10N[currentLang][key]) || L10N.ru[key] || key;
    if (!args.length) return s;
    return s.replace(/\{(\d+)\}/g, (_, i) => args[Number(i)] ?? '');
  }

  function applyLang(lang) {
    if (!L10N[lang]) lang = 'ru';
    currentLang = lang;
    localStorage.setItem('planetLang', lang);
    document.documentElement.lang = lang;

    document.getElementById('lang-toggle').querySelectorAll('.lang-opt').forEach(el => {
      el.classList.toggle('active', el.getAttribute('data-lang') === lang);
    });

    const tr = L10N[lang];
    document.title = tr.pageTitle;
    document.getElementById('login-title').textContent = tr.loginTitle;
    document.getElementById('login-sub').textContent = tr.loginSub;
    nickInput.placeholder = tr.nickPlaceholder;
    joinBtn.textContent = tr.joinBtn;

    document.getElementById('death-title').textContent = tr.deathTitle;
    document.getElementById('death-res-label').textContent = tr.deathResLabel;
    document.getElementById('death-lvl-label').textContent = tr.deathLvlLabel;
    document.getElementById('death-fleet-label').textContent = tr.deathFleetLabel;
    respawnNick.placeholder = tr.respawnPlaceholder;
    respawnBtn.textContent = tr.respawnBtn;

    document.getElementById('lbl-lvl').textContent = tr.lblLvl;
    document.getElementById('lbl-res').textContent = tr.lblRes;
    document.getElementById('lbl-fleet').textContent = tr.lblFleet;
    document.getElementById('lbl-def').textContent = tr.lblDef;
    document.getElementById('lbl-mil').textContent = tr.lblMil;
    document.getElementById('lbl-fort').textContent = tr.lblFort;
    document.getElementById('tip-lvl').textContent = tr.tipLvl;
    document.getElementById('tip-res').textContent = tr.tipRes;
    document.getElementById('tip-fleet').textContent = tr.tipFleet;
    document.getElementById('tip-def').textContent = tr.tipDef;
    document.getElementById('tip-mil').textContent = tr.tipMil;
    document.getElementById('tip-fort').textContent = tr.tipFort;
    const hudCdUnit = document.getElementById('hud-cd-unit');
    if (hudCdUnit) hudCdUnit.textContent = tr.cdUnit;

    document.getElementById('upg-title').textContent = tr.upgTitle;
    document.getElementById('buy-title').textContent = tr.buyTitle;
    document.getElementById('upg-eco-name').textContent = tr.upgEcoName;
    document.getElementById('upg-eco-desc').textContent = tr.upgEcoDesc;
    document.getElementById('upg-mil-name').textContent = tr.upgMilName;
    document.getElementById('upg-mil-desc').textContent = tr.upgMilDesc;
    document.getElementById('upg-fort-name').textContent = tr.upgFortName;
    document.getElementById('upg-fort-desc').textContent = tr.upgFortDesc;
    document.getElementById('buy-f1').textContent = tr.buyF1;
    document.getElementById('buy-f10').textContent = tr.buyF10;
    document.getElementById('buy-f1-cost').textContent = tr.buyF1Cost;
    document.getElementById('buy-f10-cost').textContent = tr.buyF10Cost;
    document.getElementById('buy-d5').textContent = tr.buyD5;
    document.getElementById('buy-d5-cost').textContent = tr.buyD5Cost;

    document.getElementById('act-center').textContent = tr.actCenter;
    document.getElementById('act-attack').textContent = tr.actAttack;
    document.getElementById('act-destruct').textContent = tr.actDestruct;
    attackHint.textContent = tr.attackHint;
    document.getElementById('onb-title').textContent = tr.onbTitle;
    document.getElementById('onb-tips').innerHTML = tr.onbTips;
    const helpTitle = document.getElementById('help-title');
    const helpBtn = document.getElementById('help-btn');
    if (helpTitle) helpTitle.textContent = tr.helpTitle;
    if (helpBtn) helpBtn.title = tr.helpBtnTitle;
    document.getElementById('help-how-title').textContent = tr.helpHowTitle;
    document.getElementById('help-how-content').innerHTML = tr.helpHowContent;
    document.getElementById('help-res-title').textContent = tr.helpResTitle;
    document.getElementById('help-res-content').innerHTML = tr.helpResContent;
    document.getElementById('help-close').textContent = tr.helpClose;

    document.getElementById('fd-title').textContent = tr.fdTitle;
    document.getElementById('fd-avail-label').textContent = tr.fdAvailLabel;
    document.getElementById('fd-ships-label').textContent = tr.fdShipsLabel;
    document.getElementById('fd-send').textContent = tr.fdSend;
    document.getElementById('fd-all').textContent = tr.fdAll;
    document.getElementById('fd-cancel').textContent = tr.fdCancel;
    fleetCountInput.placeholder = tr.fleetCountPlaceholder;
  }

  document.getElementById('lang-toggle').addEventListener('click', (e) => {
    const opt = e.target.closest('.lang-opt');
    if (opt) {
      const lang = opt.getAttribute('data-lang');
      if (lang) {
        applyLang(lang);
        if (myNick && playersArr.length && typeof updateHUD === 'function') updateHUD();
      }
    }
  });
  applyLang(currentLang);

  // ‚îÄ‚îÄ –°–æ—Å—Ç–æ—è–Ω–∏–µ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let myNick = null;
  let playersArr = [];
  let missionsArr = [];
  let asteroidsArr = [];
  let camera = { x: 0, y: 0 };
  let zoom = 1;
  const ZOOM_MIN = 0.35;
  const ZOOM_MAX = 2;
  let selecting = false;
  let selectedTarget = null;
  let animFrame = 0;
  let explosions = [];
  let comets = [];
  let needCenterOnSelf = false;
  let minerTargetEffects = []; // { asteroidId, startTime } ‚Äî –ø—É–ª—å—Å –Ω–∞ –∞—Å—Ç–µ—Ä–æ–∏–¥–µ ~2 —Å–µ–∫

  let MAP_W = 4000;
  let MAP_H = 3000;
  const MAP_VISUAL_MAX_W = 10000;
  const MAP_VISUAL_MAX_H = 7500;
  const LVL_COST_BASE = 100;
  const LVL_COST_MULT = 1.6;
  const MIL_COST_BASE = 120;
  const MIL_COST_MULT = 1.7;
  const FORT_COST_BASE = 100;
  const FORT_COST_MULT = 1.5;
  const FLEET_COST_BASE = 10;
  const FLEET_COST_MULT = 1.01;
  const DEFENSE_COST_BASE = 15;
  const DEFENSE_COST_MULT = 1.01;
  const NEWBIE_PROTECTION_LVL = 6;
  const NEWBIE_PROTECTION_TIME = 300000;
  const ATTACK_COOLDOWN = 30000;

  function fleetBuyCostClient(currentFleet, amount) {
    let total = 0;
    for (let i = 0; i < amount; i++) total += Math.floor(FLEET_COST_BASE * Math.pow(FLEET_COST_MULT, currentFleet + i));
    return total;
  }
  function defenseBuyCostClient(currentDef, amount) {
    let total = 0;
    for (let i = 0; i < amount; i++) total += Math.floor(DEFENSE_COST_BASE * Math.pow(DEFENSE_COST_MULT, currentDef + i));
    return total;
  }
  function isProtectedClient(p) {
    if (!p) return false;
    return p.isProtected === true;
  }

  const socket = io();

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // –í–ò–ó–£–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const starLayers = [
    { stars: [], speed: 0.3, count: 600, maxR: 1.0, alpha: 0.3 },
    { stars: [], speed: 0.6, count: 450, maxR: 1.5, alpha: 0.5 },
    { stars: [], speed: 1.0, count: 300, maxR: 2.0, alpha: 0.8 }
  ];
  for (const layer of starLayers) {
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∑–≤—ë–∑–¥—ã –≤ –æ–≥—Ä–æ–º–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏ (–≤ 3 —Ä–∞–∑–∞ –±–æ–ª—å—à–µ –∫–∞—Ä—Ç—ã)
    for (let i = 0; i < layer.count; i++) {
      layer.stars.push({
        x: Math.random() * MAP_VISUAL_MAX_W * 3,
        y: Math.random() * MAP_VISUAL_MAX_H * 3,
        r: Math.random() * layer.maxR + 0.2,
        flicker: Math.random() * Math.PI * 2
      });
    }
  }

  // –ó–≤—ë–∑–¥–Ω—ã–µ —Å–∫–æ–ø–ª–µ–Ω–∏—è (–ø–ª–µ—è–¥—ã)
  const starClusters = [];
  for (let i = 0; i < 5; i++) {
    const cx = Math.random() * MAP_VISUAL_MAX_W * 2;
    const cy = Math.random() * MAP_VISUAL_MAX_H * 2;
    const clusterSize = 8 + Math.random() * 12; // 8-20 –∑–≤—ë–∑–¥
    const stars = [];
    for (let j = 0; j < clusterSize; j++) {
      const angle = Math.random() * Math.PI * 2;
      const dist = Math.random() * 60 + 10;
      stars.push({
        x: cx + Math.cos(angle) * dist,
        y: cy + Math.sin(angle) * dist,
        r: 0.8 + Math.random() * 1.2,
        flicker: Math.random() * Math.PI * 2
      });
    }
    starClusters.push({ stars, speed: 0.4 });
  }

  // –°–≤–µ—Ä—Ö–Ω–æ–≤—ã–µ (—è—Ä–∫–∏–µ –ø—É–ª—å—Å–∏—Ä—É—é—â–∏–µ –∑–≤—ë–∑–¥—ã)
  const supernovas = [];
  for (let i = 0; i < 4; i++) {
    supernovas.push({
      x: Math.random() * MAP_VISUAL_MAX_W * 2,
      y: Math.random() * MAP_VISUAL_MAX_H * 2,
      r: 3 + Math.random() * 2,
      hue: Math.random() * 60 + (i % 2 === 0 ? 200 : 320), // –°–∏–Ω–∏–µ –∏ —Ä–æ–∑–æ–≤—ã–µ
      speed: 0.5,
      pulsePhase: Math.random() * Math.PI * 2,
      pulseSpeed: 0.02 + Math.random() * 0.01
    });
  }

  const nebulae = [];
  for (let i = 0; i < 6; i++) {
    nebulae.push({
      x: Math.random() * MAP_VISUAL_MAX_W,
      y: Math.random() * MAP_VISUAL_MAX_H,
      r: 200 + Math.random() * 400,
      hue: Math.random() * 360,
      alpha: 0.03 + Math.random() * 0.04
    });
  }

  function spawnComet() {
    // –°–ø–∞–≤–Ω –¥–∞–ª–µ–∫–æ –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –∫–∞—Ä—Ç—ã, —á—Ç–æ–±—ã –ø—Ä–∏ –º–∞–∫—Å. –æ—Ç–¥–∞–ª–µ–Ω–∏–∏ –Ω–µ –±—ã–ª–æ –≤–∏–¥–Ω–æ –ø–æ—è–≤–ª–µ–Ω–∏—è
    const margin = 800;
    const fromLeft = Math.random() > 0.5;
    return {
      x: fromLeft ? -margin : MAP_W + margin,
      y: -margin + Math.random() * (MAP_H + margin * 2),
      vx: (fromLeft ? 1 : -1) * (1.5 + Math.random() * 2),
      vy: (Math.random() - 0.5) * 0.8,
      tailLen: 40 + Math.random() * 60,
      hue: Math.random() * 60 + 180,
      life: 1
    };
  }
  for (let i = 0; i < 3; i++) comets.push(spawnComet());

  function resize() {
    canvas.width = bloomC.width = window.innerWidth;
    canvas.height = bloomC.height = window.innerHeight;
  }
  window.addEventListener('resize', resize);
  resize();

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // –í–•–û–î / –†–ï–°–ü–ê–í–ù
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  function showScreen(screen) {
    loginScreen.style.display = 'none';
    deathScreen.style.display = 'none';
    gameScreen.style.display = 'none';
    screen.style.display = screen === gameScreen ? 'block' : 'flex';
  }

  function tryJoin(nick, errorEl) {
    socket.emit('join', nick, (resp) => {
      if (!resp.ok) { errorEl.textContent = resp.msg; return; }
      myNick = nick;
      localStorage.setItem('planetNick', nick);
      showScreen(gameScreen);
      hudNick.textContent = nick;
      needCenterOnSelf = true;
      // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É –Ω–æ–≤–∏—á–∫–∞–º
      if (!localStorage.getItem('onboardingSeen')) {
        onboarding.style.display = 'block';
      }
    });
  }

  // –ê–≤—Ç–æ–≤—Ö–æ–¥
  const savedNick = localStorage.getItem('planetNick');
  if (savedNick) {
    nickInput.value = savedNick;
    socket.on('connect', () => tryJoin(savedNick, loginError));
  } else {
    socket.on('connect', () => {});
  }

  joinBtn.addEventListener('click', () => tryJoin(nickInput.value.trim(), loginError));
  nickInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') tryJoin(nickInput.value.trim(), loginError); });

  respawnBtn.addEventListener('click', () => tryJoin(respawnNick.value.trim(), respawnError));
  respawnNick.addEventListener('keydown', (e) => { if (e.key === 'Enter') tryJoin(respawnNick.value.trim(), respawnError); });

  // –ó–∞–∫—Ä—ã—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É
  document.getElementById('close-onboarding').addEventListener('click', () => {
    onboarding.style.display = 'none';
    localStorage.setItem('onboardingSeen', '1');
  });

  // –¢–æ–≥–≥–ª –ø–∞–Ω–µ–ª–∏ —É–ª—É—á—à–µ–Ω–∏–π (–º–æ–±–∏–ª—å–Ω—ã–µ)
  const upgToggle = document.getElementById('upg-toggle');
  const upgradePanel = document.getElementById('upgrade-panel');
  upgToggle.addEventListener('click', () => {
    const isOpen = upgradePanel.classList.toggle('mobile-open');
    upgToggle.classList.toggle('active', isOpen);
  });

  // –¢–æ–≥–≥–ª —á–∞—Ç–∞ (–º–æ–±–∏–ª—å–Ω—ã–µ)
  const chatToggle = document.getElementById('chat-toggle');
  chatToggle.addEventListener('click', () => {
    chatBox.classList.toggle('hidden');
  });

  const helpPanel = document.getElementById('help-panel');
  document.getElementById('help-btn').addEventListener('click', () => {
    helpPanel.style.display = 'block';
  });
  document.getElementById('help-close').addEventListener('click', () => {
    helpPanel.style.display = 'none';
  });

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // –°–û–ë–´–¢–ò–Ø –°–ï–†–í–ï–†–ê
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  socket.on('state', (data) => {
    if (Array.isArray(data)) {
      playersArr = data;
    } else {
      if (data.list) playersArr = data.list;
      if (data.mapW != null) MAP_W = data.mapW;
      if (data.mapH != null) MAP_H = data.mapH;
    }
    updateHUD();
    updateTradePlayerSelect();
    if (needCenterOnSelf) { centerOnSelf(); needCenterOnSelf = false; }
  });

  socket.on('missions', (list) => {
    missionsArr = list;
    checkIncoming();
  });

  socket.on('asteroids', (list) => { asteroidsArr = list; });
  socket.on('upgraded', () => updateHUD());
  socket.on('fleetBought', () => updateHUD());
  socket.on('defenseBought', () => updateHUD());
  socket.on('minerSent', (data) => {
    updateHUD();
    showToast(t('minerSentToast'));
    if (data && data.asteroidId) minerTargetEffects.push({ asteroidId: data.asteroidId, startTime: Date.now() });
  });

  socket.on('attackResult', (data) => {
    selecting = false;
    attackHint.style.display = 'none';
    if (!data.ok) {
      showToast(data.msg);
    } else if (data.launched) {
      showToast(t('fleetSentToast', data.fleetSent, data.eta));
    }
  });

  socket.on('explosion', (data) => createExplosion(data.x, data.y, data.big));
  socket.on('chat', (msg) => addChat(msg.from, msg.text));
  socket.on('info', (msg) => showToast(msg));

  // –°–∞–º–æ—É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ
  socket.on('destroyed', () => {
    myNick = null;
    localStorage.removeItem('planetNick');
    showScreen(loginScreen);
    nickInput.value = '';
    loginError.textContent = '';
  });

  // –ü–æ—Ä–∞–∂–µ–Ω–∏–µ –≤ –±–æ—é ‚Äî —ç–∫—Ä–∞–Ω —Å–º–µ—Ä—Ç–∏
  socket.on('defeated', (data) => {
    myNick = null;
    localStorage.removeItem('planetNick');
    document.getElementById('death-killer').textContent = t('deathKillerBy', data.killedBy);
    document.getElementById('death-res').textContent = data.lostRes;
    document.getElementById('death-lvl').textContent = data.hadLvl;
    document.getElementById('death-fleet').textContent = data.hadFleet;
    respawnNick.value = '';
    respawnError.textContent = '';
    showScreen(deathScreen);
  });

  // ‚îÄ‚îÄ –í—Ö–æ–¥—è—â–∏–µ –∞—Ç–∞–∫–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function checkIncoming() {
    const incoming = missionsArr.some(m => m.type === 'attack' && m.targetNick === myNick);
    incomingWarn.classList.toggle('active', incoming);
  }

  // ‚îÄ‚îÄ HUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function updateHUD() {
    const me = playersArr.find(p => p.nick === myNick);
    if (!me) return;
    hudLvl.textContent = me.lvl;
    hudRes.textContent = me.res;
    hudFleet.textContent = me.fleet;
    hudDef.textContent = me.defense;
    hudMil.textContent = me.militaryLvl;
    hudFort.textContent = me.fortLvl;
    if (me.allianceName) {
      hudAllianceWrap.style.display = '';
      hudAlliance.textContent = me.allianceName;
    } else {
      hudAllianceWrap.style.display = 'none';
    }

    // –ó–∞—â–∏—Ç–∞ –Ω–æ–≤–∏—á–∫–∞ –≤ HUD
    const protEl = document.getElementById('hud-protected');
    if (protEl) {
      if (isProtectedClient(me)) {
        protEl.style.display = '';
        protEl.textContent = t('protectedHud');
      } else {
        protEl.style.display = 'none';
      }
    }

    const resShort = t('resShort');
    document.getElementById('cost-eco').textContent =
      `${Math.floor(LVL_COST_BASE * Math.pow(LVL_COST_MULT, me.lvl - 1))} ${resShort}`;
    document.getElementById('cost-mil').textContent =
      `${Math.floor(MIL_COST_BASE * Math.pow(MIL_COST_MULT, me.militaryLvl))} ${resShort}`;
    document.getElementById('cost-fort').textContent =
      `${Math.floor(FORT_COST_BASE * Math.pow(FORT_COST_MULT, me.fortLvl))} ${resShort}`;

    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ü–µ–Ω—ã –∫–æ—Ä–∞–±–ª–µ–π/—â–∏—Ç–æ–≤ (—Å —É—á—ë—Ç–æ–º —Ñ–ª–æ—Ç–∞ –≤ –º–∏—Å—Å–∏—è—Ö)
    const fleetInMissions = missionsArr
      .filter(m => m.owner === myNick && m.fleetCount)
      .reduce((sum, m) => sum + m.fleetCount, 0);
    const effectiveFleet = me.fleet + fleetInMissions;

    document.getElementById('buy-f1-cost').textContent =
      `${fleetBuyCostClient(effectiveFleet, 1)} ${resShort}`;
    document.getElementById('buy-f10-cost').textContent =
      `${fleetBuyCostClient(effectiveFleet, 10)} ${resShort}`;
    document.getElementById('buy-d5-cost').textContent =
      `${defenseBuyCostClient(me.defense, 5)} ${resShort}`;
  }

  // –ö—É–ª–¥–∞—É–Ω
  setInterval(() => {
    const me = playersArr.find(p => p.nick === myNick);
    if (!me) return;
    const remain = Math.max(0, ATTACK_COOLDOWN - (Date.now() - me.lastAttack));
    if (remain > 0) {
      hudCd.style.display = '';
      hudCdVal.textContent = Math.ceil(remain / 1000);
    } else {
      hudCd.style.display = 'none';
    }
  }, 500);

  // ‚îÄ‚îÄ –ß–∞—Ç / –¢–æ—Å—Ç—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function addChat(from, text) {
    const div = document.createElement('div');
    div.innerHTML = `<span class="from">${from}:</span> ${text}`;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
    while (chatBox.children.length > 50) chatBox.removeChild(chatBox.firstChild);
  }

  function showToast(msg) {
    infoToast.textContent = msg;
    infoToast.style.display = 'block';
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => infoToast.style.display = 'none', 3000);
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // –ö–ù–û–ü–ö–ò
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  document.getElementById('btn-upg-eco').addEventListener('click', () => socket.emit('upgradeLvl'));
  document.getElementById('btn-upg-mil').addEventListener('click', () => socket.emit('upgradeMilitary'));
  document.getElementById('btn-upg-fort').addEventListener('click', () => socket.emit('upgradeFort'));
  document.getElementById('btn-fleet1').addEventListener('click', () => socket.emit('buyFleet', 1));
  document.getElementById('btn-fleet10').addEventListener('click', () => socket.emit('buyFleet', 10));
  document.getElementById('btn-def5').addEventListener('click', () => socket.emit('buyDefense', 5));
  document.getElementById('btn-center').addEventListener('click', centerOnSelf);
  document.getElementById('btn-attack-mode').addEventListener('click', () => {
    selecting = !selecting;
    attackHint.style.display = selecting ? 'block' : 'none';
  });
  // –ê–ª—å—è–Ω—Å / –¢–æ—Ä–≥–æ–≤–ª—è / –õ–∏–¥–µ—Ä–±–æ—Ä–¥
  function openPanel(panel) {
    alliancePanel.style.display = 'none';
    tradePanel.style.display = 'none';
    leaderboardPanel.style.display = 'none';
    if (panel) panel.style.display = 'block';
  }
  function updateTradePlayerSelect() {
    const currentValue = tradePlayerSelect.value; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä
    const me = playersArr.find(p => p.nick === myNick);
    const others = playersArr.filter(p => p.nick !== myNick && p.nick && !p.isBot); // –ò—Å–∫–ª—é—á–∞–µ–º –±–æ—Ç–æ–≤
    tradePlayerSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞</option>' +
      others.map(p => `<option value="${p.nick}">${p.nick} (${p.res} res)</option>`).join('');
    if (currentValue && others.some(p => p.nick === currentValue)) {
      tradePlayerSelect.value = currentValue; // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º, –µ—Å–ª–∏ –∏–≥—Ä–æ–∫ –≤—Å—ë –µ—â—ë –≤ —Å–ø–∏—Å–∫–µ
    }
  }
  function fillLeaderboard() {
    const byLvl = [...playersArr].sort((a,b) => (b.lvl||0) - (a.lvl||0)).slice(0, 10);
    const byRes = [...playersArr].sort((a,b) => (b.res||0) - (a.res||0)).slice(0, 10);
    const byWins = [...playersArr].sort((a,b) => (b.wins||0) - (a.wins||0)).slice(0, 10);
    document.getElementById('leader-lvl').innerHTML = byLvl.map((p,i) => `<div class="row"><span class="nick">${i+1}. ${p.nick}</span><span class="val">${p.lvl}</span></div>`).join('');
    document.getElementById('leader-res').innerHTML = byRes.map((p,i) => `<div class="row"><span class="nick">${i+1}. ${p.nick}</span><span class="val">${p.res}</span></div>`).join('');
    document.getElementById('leader-wins').innerHTML = byWins.map((p,i) => `<div class="row"><span class="nick">${i+1}. ${p.nick}</span><span class="val">${p.wins||0}</span></div>`).join('');
  }
  document.getElementById('btn-alliance').addEventListener('click', () => {
    const me = playersArr.find(p => p.nick === myNick);
    allianceCurrent.textContent = me && me.allianceName ? `–°–µ–π—á–∞—Å: ¬´${me.allianceName}¬ª` : '–°–µ–π—á–∞—Å: –Ω–µ—Ç';
    allianceNameInput.value = me && me.allianceName ? me.allianceName : '';
    openPanel(alliancePanel);
  });
  document.getElementById('alliance-create').addEventListener('click', () => {
    const name = allianceNameInput.value.trim();
    if (!name) return;
    socket.emit('createAlliance', name, (r) => { if (r && r.ok) openPanel(null); else if (r && r.msg) showToast(r.msg); });
  });
  document.getElementById('alliance-join').addEventListener('click', () => {
    const name = allianceNameInput.value.trim();
    if (!name) return;
    socket.emit('joinAlliance', name, (r) => { if (r && r.ok) openPanel(null); else if (r && r.msg) showToast(r.msg); });
  });
  document.getElementById('alliance-leave').addEventListener('click', () => {
    socket.emit('leaveAlliance', (r) => { if (r && r.ok) openPanel(null); });
  });
  document.getElementById('alliance-close').addEventListener('click', () => openPanel(null));
  document.getElementById('btn-trade').addEventListener('click', () => {
    updateTradePlayerSelect();
    tradeAmountInput.value = '';
    openPanel(tradePanel);
  });
  document.getElementById('trade-send').addEventListener('click', () => {
    const to = tradePlayerSelect.value;
    const amount = parseInt(tradeAmountInput.value, 10);
    if (!to || !amount || amount < 1) { showToast('–£–∫–∞–∂–∏—Ç–µ –∏–≥—Ä–æ–∫–∞ –∏ —Å—É–º–º—É'); return; }
    socket.emit('trade', { to, amount }, (r) => {
      if (r && r.ok) { openPanel(null); showToast('–†–µ—Å—É—Ä—Å—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã'); }
      else if (r && r.msg) showToast(r.msg);
    });
  });
  document.getElementById('trade-close').addEventListener('click', () => openPanel(null));
  document.getElementById('btn-leaderboard').addEventListener('click', () => {
    fillLeaderboard();
    openPanel(null);
    leaderboardPanel.style.display = 'grid';
  });
  document.getElementById('leaderboard-close').addEventListener('click', () => openPanel(null));

  document.getElementById('btn-destruct').addEventListener('click', () => {
    if (confirm(t('confirmDestruct'))) socket.emit('selfDestruct');
  });

  // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
  window.addEventListener('keydown', (e) => {
    if (document.activeElement.tagName === 'INPUT') return;
    if (e.code === 'Space') { e.preventDefault(); centerOnSelf(); }
    if (e.code === 'Escape') {
      selecting = false;
      attackHint.style.display = 'none';
      fleetDialog.style.display = 'none';
      if (helpPanel.style.display === 'block') helpPanel.style.display = 'none';
      else if (alliancePanel.style.display === 'block') openPanel(null);
      else if (tradePanel.style.display === 'block') openPanel(null);
      else if (leaderboardPanel.style.display === 'grid') openPanel(null);
    }
  });

  // ‚îÄ‚îÄ –ö–∞–º–µ—Ä–∞ –∏ –∑—É–º ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function centerOnSelf() {
    const me = playersArr.find(p => p.nick === myNick);
    if (me) {
      camera.x = me.x - canvas.width / (2 * zoom);
      camera.y = me.y - canvas.height / (2 * zoom);
    }
  }

  canvas.addEventListener('wheel', (e) => {
    e.preventDefault();
    const delta = e.deltaY > 0 ? -0.12 : 0.12;
    const newZoom = Math.max(ZOOM_MIN, Math.min(ZOOM_MAX, zoom + delta));
    if (newZoom === zoom) return;
    const rect = canvas.getBoundingClientRect();
    const sx = e.clientX - rect.left, sy = e.clientY - rect.top;
    const wx = camera.x + sx / zoom, wy = camera.y + sy / zoom;
    zoom = newZoom;
    camera.x = wx - sx / zoom;
    camera.y = wy - sy / zoom;
  }, { passive: false });

  let dragging = false, dragStart = { x: 0, y: 0 };

  canvas.addEventListener('mousedown', (e) => {
    if (e.button === 2) { dragging = true; dragStart = { x: e.clientX, y: e.clientY }; }
  });
  canvas.addEventListener('mousemove', (e) => {
    if (dragging) {
      camera.x -= (e.clientX - dragStart.x) / zoom;
      camera.y -= (e.clientY - dragStart.y) / zoom;
      dragStart = { x: e.clientX, y: e.clientY };
    }
  });
  canvas.addEventListener('mouseup', (e) => { if (e.button === 2) dragging = false; });
  canvas.addEventListener('contextmenu', (e) => e.preventDefault());

  // ‚îÄ‚îÄ –¢–∞—á-—Å–æ–±—ã—Ç–∏—è: –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã + –ø–∏–Ω—á-–∑—É–º (–º–æ–±–∏–ª—å–Ω—ã–µ) ‚îÄ‚îÄ
  let touchDragging = false;
  let touchStart = { x: 0, y: 0 };
  let touchMoved = false;
  let pinching = false;
  let pinchStartDist = 0;
  let pinchStartZoom = 1;
  let pinchCenter = { x: 0, y: 0 };

  function getTouchDist(t1, t2) {
    const dx = t1.clientX - t2.clientX, dy = t1.clientY - t2.clientY;
    return Math.sqrt(dx * dx + dy * dy);
  }
  function getTouchCenter(t1, t2) {
    return { x: (t1.clientX + t2.clientX) / 2, y: (t1.clientY + t2.clientY) / 2 };
  }

  canvas.addEventListener('touchstart', (e) => {
    if (e.touches.length === 2) {
      // –ù–∞—á–∞–ª–æ –ø–∏–Ω—á-–∑—É–º–∞
      pinching = true;
      touchDragging = false;
      pinchStartDist = getTouchDist(e.touches[0], e.touches[1]);
      pinchStartZoom = zoom;
      pinchCenter = getTouchCenter(e.touches[0], e.touches[1]);
    } else if (e.touches.length === 1 && !pinching) {
      touchDragging = true;
      touchMoved = false;
      touchStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
    }
  }, { passive: true });

  canvas.addEventListener('touchmove', (e) => {
    if (pinching && e.touches.length === 2) {
      // –ü–∏–Ω—á-–∑—É–º
      e.preventDefault();
      const curDist = getTouchDist(e.touches[0], e.touches[1]);
      const scale = curDist / pinchStartDist;
      const newZoom = Math.max(ZOOM_MIN, Math.min(ZOOM_MAX, pinchStartZoom * scale));
      if (newZoom !== zoom) {
        const rect = canvas.getBoundingClientRect();
        const center = getTouchCenter(e.touches[0], e.touches[1]);
        const sx = center.x - rect.left, sy = center.y - rect.top;
        const wx = camera.x + sx / zoom, wy = camera.y + sy / zoom;
        zoom = newZoom;
        camera.x = wx - sx / zoom;
        camera.y = wy - sy / zoom;
      }
      return;
    }
    if (!touchDragging || e.touches.length !== 1) return;
    const tx = e.touches[0].clientX, ty = e.touches[0].clientY;
    const dx = tx - touchStart.x, dy = ty - touchStart.y;
    if (Math.abs(dx) > 3 || Math.abs(dy) > 3) touchMoved = true;
    if (touchMoved) {
      camera.x -= dx / zoom;
      camera.y -= dy / zoom;
      touchStart = { x: tx, y: ty };
      e.preventDefault();
    }
  }, { passive: false });

  canvas.addEventListener('touchend', (e) => {
    if (e.touches.length < 2) pinching = false;
    if (touchDragging && !touchMoved && e.changedTouches.length === 1 && e.touches.length === 0) {
      // –ï—Å–ª–∏ –Ω–µ –¥–≤–∏–≥–∞–ª–∏ ‚Äî —ç–º—É–ª–∏—Ä—É–µ–º –∫–ª–∏–∫
      const t = e.changedTouches[0];
      const clickEvent = new MouseEvent('click', {
        clientX: t.clientX, clientY: t.clientY,
        bubbles: true
      });
      canvas.dispatchEvent(clickEvent);
    }
    if (e.touches.length === 0) {
      touchDragging = false;
      touchMoved = false;
    }
  }, { passive: true });

  // ‚îÄ‚îÄ –ö–ª–∏–∫ –ø–æ canvas (—ç–∫—Ä–∞–Ω ‚Üí –º–∏—Ä —Å —É—á—ë—Ç–æ–º –∑—É–º–∞) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  canvas.addEventListener('click', (e) => {
    if (fleetDialog.style.display === 'block') return;
    const rect = canvas.getBoundingClientRect();
    const sx = e.clientX - rect.left, sy = e.clientY - rect.top;
    const wx = camera.x + sx / zoom;
    const wy = camera.y + sy / zoom;

    // –ê—Å—Ç–µ—Ä–æ–∏–¥—ã
    for (const a of asteroidsArr) {
      const dx = wx - a.x, dy = wy - a.y;
      if (dx * dx + dy * dy < 20 * 20) {
        socket.emit('mine', a.id);
        return;
      }
    }

    // –ü–ª–∞–Ω–µ—Ç—ã
    for (const p of playersArr) {
      const r = planetRadius(p.lvl);
      const dx = wx - p.x, dy = wy - p.y;
      if (dx * dx + dy * dy < (r + 10) * (r + 10)) {
        if (p.nick === myNick) {
          selecting = !selecting;
          attackHint.style.display = selecting ? 'block' : 'none';
          return;
        }
        if (selecting) {
          if (isProtectedClient(p)) {
            showToast(t('protectedAttackMsg'));
            return;
          }
          openFleetDialog(p.nick);
          return;
        }
      }
    }

    if (selecting) { selecting = false; attackHint.style.display = 'none'; }
  });

  // ‚îÄ‚îÄ –î–∏–∞–ª–æ–≥ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–ª–æ—Ç–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function openFleetDialog(targetNick) {
    selectedTarget = targetNick;
    fleetDialogTarget.textContent = targetNick;
    const me = playersArr.find(p => p.nick === myNick);
    fleetAvailSpan.textContent = me ? me.fleet : 0;
    fleetCountInput.value = me ? me.fleet : 0;
    fleetCountInput.max = me ? me.fleet : 0;
    fleetDialog.style.display = 'block';
    fleetCountInput.focus();
    fleetCountInput.select();
  }

  document.getElementById('fleet-send-btn').addEventListener('click', () => {
    const count = parseInt(fleetCountInput.value) || 0;
    if (count > 0 && selectedTarget) socket.emit('attack', { target: selectedTarget, count });
    fleetDialog.style.display = 'none';
    selecting = false; attackHint.style.display = 'none';
  });
  document.getElementById('fleet-all-btn').addEventListener('click', () => {
    const me = playersArr.find(p => p.nick === myNick);
    if (me && me.fleet > 0 && selectedTarget) socket.emit('attack', { target: selectedTarget, count: me.fleet });
    fleetDialog.style.display = 'none';
    selecting = false; attackHint.style.display = 'none';
  });
  document.getElementById('fleet-cancel-btn').addEventListener('click', () => fleetDialog.style.display = 'none');
  fleetCountInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') document.getElementById('fleet-send-btn').click();
    if (e.key === 'Escape') fleetDialog.style.display = 'none';
  });

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // –£–¢–ò–õ–ò–¢–´
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  function planetRadius(lvl) { return 18 + lvl * 4; }
  function lighten(hsl, amt) {
    const m = hsl.match(/hsl\((\d+),\s*([\d.]+)%,\s*([\d.]+)%\)/);
    if (!m) return hsl;
    return `hsl(${m[1]}, ${m[2]}%, ${Math.min(100, parseFloat(m[3]) + amt)}%)`;
  }
  function darken(hsl, amt) {
    const m = hsl.match(/hsl\((\d+),\s*([\d.]+)%,\s*([\d.]+)%\)/);
    if (!m) return hsl;
    return `hsl(${m[1]}, ${m[2]}%, ${Math.max(0, parseFloat(m[3]) - amt)}%)`;
  }

  function createExplosion(x, y, big) {
    const count = big ? 60 : 25;
    const particles = [];
    for (let i = 0; i < count; i++) {
      const angle = Math.random() * Math.PI * 2;
      const speed = Math.random() * (big ? 5 : 3) + 1;
      particles.push({
        x, y,
        vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed,
        life: 1,
        color: big
          ? `hsl(${Math.random()*60+10}, 100%, ${50+Math.random()*30}%)`
          : `hsl(${Math.random()*40+200}, 80%, 60%)`
      });
    }
    explosions.push({ particles });
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // –†–ï–ù–î–ï–†
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  function draw() {
    animFrame++;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    bloomCtx.clearRect(0, 0, canvas.width, canvas.height);

    drawNebulae();
    drawStars();
    drawStarClusters();
    drawSupernovas();
    drawComets();
    drawGrid();
    drawAsteroids();
    drawMissions();
    drawPlanets();
    drawExplosions();
    drawMinimap();

    requestAnimationFrame(draw);
  }

  function drawNebulae() {
    for (const n of nebulae) {
      const sx = (n.x - camera.x) * zoom, sy = (n.y - camera.y) * zoom;
      const nr = n.r * zoom;
      if (sx < -nr*2 || sx > canvas.width+nr*2 || sy < -nr*2 || sy > canvas.height+nr*2) continue;
      const grad = ctx.createRadialGradient(sx, sy, 0, sx, sy, nr);
      grad.addColorStop(0, `hsla(${n.hue}, 60%, 40%, ${n.alpha})`);
      grad.addColorStop(0.5, `hsla(${n.hue+30}, 50%, 30%, ${n.alpha*0.5})`);
      grad.addColorStop(1, `hsla(${n.hue}, 40%, 20%, 0)`);
      ctx.fillStyle = grad;
      ctx.beginPath(); ctx.arc(sx, sy, nr, 0, Math.PI*2); ctx.fill();
      bloomCtx.fillStyle = grad;
      bloomCtx.beginPath(); bloomCtx.arc(sx, sy, nr, 0, Math.PI*2); bloomCtx.fill();
    }
  }

  function drawStars() {
    for (const layer of starLayers) {
      for (const s of layer.stars) {
        // –ü–æ–∑–∏—Ü–∏—è —Å –ø–∞—Ä–∞–ª–ª–∞–∫—Å–æ–º (–ø—Ä–æ—Å—Ç–∞—è —Ñ–æ—Ä–º—É–ª–∞ –±–µ–∑ –æ–±—ë—Ä—Ç–∫–∏)
        const sx = (s.x - camera.x * layer.speed) * zoom;
        const sy = (s.y - camera.y * layer.speed) * zoom;

        // –†–∏—Å—É–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
        if (sx < -10 || sx > canvas.width+10 || sy < -10 || sy > canvas.height+10) continue;

        ctx.globalAlpha = Math.max(0.05, layer.alpha + Math.sin(animFrame*0.03+s.flicker)*0.15);
        ctx.fillStyle = '#fff';
        ctx.beginPath(); ctx.arc(sx, sy, s.r, 0, Math.PI*2); ctx.fill();
      }
    }
    ctx.globalAlpha = 1;
  }

  function drawStarClusters() {
    for (const cluster of starClusters) {
      for (const s of cluster.stars) {
        const sx = (s.x - camera.x * cluster.speed) * zoom;
        const sy = (s.y - camera.y * cluster.speed) * zoom;

        if (sx < -10 || sx > canvas.width+10 || sy < -10 || sy > canvas.height+10) continue;

        // –ì–æ–ª—É–±–æ–≤–∞—Ç—ã–π –æ—Ç—Ç–µ–Ω–æ–∫ –¥–ª—è —Å–∫–æ–ø–ª–µ–Ω–∏–π
        const flicker = Math.sin(animFrame*0.04+s.flicker)*0.2;
        ctx.globalAlpha = 0.7 + flicker;
        ctx.fillStyle = '#d4e8ff';
        ctx.shadowColor = '#a0c8ff';
        ctx.shadowBlur = 3;
        ctx.beginPath(); ctx.arc(sx, sy, s.r, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;

        // Bloom –¥–ª—è —Å–∫–æ–ø–ª–µ–Ω–∏–π
        bloomCtx.globalAlpha = 0.3;
        bloomCtx.fillStyle = '#a0c8ff';
        bloomCtx.beginPath(); bloomCtx.arc(sx, sy, s.r*2, 0, Math.PI*2); bloomCtx.fill();
      }
    }
    ctx.globalAlpha = 1;
    bloomCtx.globalAlpha = 1;
  }

  function drawSupernovas() {
    for (const sn of supernovas) {
      const sx = (sn.x - camera.x * sn.speed) * zoom;
      const sy = (sn.y - camera.y * sn.speed) * zoom;

      if (sx < -50 || sx > canvas.width+50 || sy < -50 || sy > canvas.height+50) continue;

      // –ü—É–ª—å—Å–∞—Ü–∏—è —Å–≤–µ—Ä—Ö–Ω–æ–≤–æ–π
      sn.pulsePhase += sn.pulseSpeed;
      const pulse = 0.7 + Math.sin(sn.pulsePhase) * 0.3;
      const r = sn.r * pulse * zoom;

      // –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —è—Ä–∫–∞—è –∑–≤–µ–∑–¥–∞
      const innerGrad = ctx.createRadialGradient(sx, sy, 0, sx, sy, r);
      innerGrad.addColorStop(0, `hsla(${sn.hue}, 100%, 95%, ${pulse})`);
      innerGrad.addColorStop(0.3, `hsla(${sn.hue}, 90%, 80%, ${pulse*0.8})`);
      innerGrad.addColorStop(1, `hsla(${sn.hue}, 70%, 60%, 0)`);
      ctx.fillStyle = innerGrad;
      ctx.beginPath(); ctx.arc(sx, sy, r, 0, Math.PI*2); ctx.fill();

      // –°–∏—è–Ω–∏–µ (bloom)
      const outerGrad = bloomCtx.createRadialGradient(sx, sy, 0, sx, sy, r*3);
      outerGrad.addColorStop(0, `hsla(${sn.hue}, 100%, 70%, ${pulse*0.6})`);
      outerGrad.addColorStop(0.5, `hsla(${sn.hue}, 80%, 50%, ${pulse*0.3})`);
      outerGrad.addColorStop(1, `hsla(${sn.hue}, 60%, 40%, 0)`);
      bloomCtx.fillStyle = outerGrad;
      bloomCtx.beginPath(); bloomCtx.arc(sx, sy, r*3, 0, Math.PI*2); bloomCtx.fill();

      // –õ—É—á–∏ –æ—Ç —Å–≤–µ—Ä—Ö–Ω–æ–≤–æ–π
      for (let i = 0; i < 4; i++) {
        const angle = sn.pulsePhase * 0.5 + (i * Math.PI / 2);
        const rayLen = r * (2 + Math.sin(sn.pulsePhase*2 + i) * 0.5);
        const endX = sx + Math.cos(angle) * rayLen;
        const endY = sy + Math.sin(angle) * rayLen;
        const rayGrad = ctx.createLinearGradient(sx, sy, endX, endY);
        rayGrad.addColorStop(0, `hsla(${sn.hue}, 100%, 90%, ${pulse*0.4})`);
        rayGrad.addColorStop(1, `hsla(${sn.hue}, 80%, 70%, 0)`);
        ctx.strokeStyle = rayGrad;
        ctx.lineWidth = 1.5;
        ctx.beginPath(); ctx.moveTo(sx, sy); ctx.lineTo(endX, endY); ctx.stroke();
      }
    }
  }

  function drawComets() {
    for (let i = comets.length-1; i >= 0; i--) {
      const c = comets[i];
      c.x += c.vx; c.y += c.vy;
      const sx = (c.x - camera.x) * zoom, sy = (c.y - camera.y) * zoom;
      const tailX = sx - c.vx*c.tailLen, tailY = sy - c.vy*c.tailLen;
      const grad = ctx.createLinearGradient(sx, sy, tailX, tailY);
      grad.addColorStop(0, `hsla(${c.hue},80%,70%,.8)`);
      grad.addColorStop(1, `hsla(${c.hue},60%,40%,0)`);
      ctx.strokeStyle = grad; ctx.lineWidth = 2;
      ctx.beginPath(); ctx.moveTo(sx, sy); ctx.lineTo(tailX, tailY); ctx.stroke();
      ctx.fillStyle = `hsla(${c.hue},90%,80%,.9)`;
      ctx.beginPath(); ctx.arc(sx, sy, 2.5, 0, Math.PI*2); ctx.fill();
      bloomCtx.fillStyle = `hsla(${c.hue},90%,70%,.6)`;
      bloomCtx.beginPath(); bloomCtx.arc(sx, sy, 4, 0, Math.PI*2); bloomCtx.fill();
      if (c.x < -1000 || c.x > MAP_W+1000 || c.y < -1000 || c.y > MAP_H+1000) comets[i] = spawnComet();
    }
    if (Math.random() < 0.002 && comets.length < 5) comets.push(spawnComet());
  }

  function drawGrid() {
    ctx.strokeStyle = 'rgba(255,255,255,0.025)'; ctx.lineWidth = 1;
    const gs = 200;
    const wLeft = camera.x, wRight = camera.x + canvas.width/zoom, wTop = camera.y, wBottom = camera.y + canvas.height/zoom;
    for (let wx = Math.floor(wLeft/gs)*gs; wx <= wRight+gs; wx += gs) {
      const sx = (wx - camera.x) * zoom;
      ctx.beginPath(); ctx.moveTo(sx,0); ctx.lineTo(sx,canvas.height); ctx.stroke();
    }
    for (let wy = Math.floor(wTop/gs)*gs; wy <= wBottom+gs; wy += gs) {
      const sy = (wy - camera.y) * zoom;
      ctx.beginPath(); ctx.moveTo(0,sy); ctx.lineTo(canvas.width,sy); ctx.stroke();
    }
  }

  function drawAsteroids() {
    const now = Date.now();
    minerTargetEffects = minerTargetEffects.filter(e => now - e.startTime < 2500);
    for (const a of asteroidsArr) {
      const sx = (a.x-camera.x)*zoom, sy = (a.y-camera.y)*zoom;
      if (sx < -30 || sx > canvas.width+30 || sy < -30 || sy > canvas.height+30) continue;
      const effect = minerTargetEffects.find(e => e.asteroidId === a.id);
      const effectAge = effect ? (now - effect.startTime) / 1000 : 999;
      ctx.fillStyle = '#8d6e63'; ctx.shadowColor = '#ff8f00'; ctx.shadowBlur = 6;
      ctx.beginPath(); ctx.arc(sx, sy, 10, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = '#a1887f';
      ctx.beginPath(); ctx.arc(sx-3, sy-2, 6, 0, Math.PI*2); ctx.fill();
      ctx.shadowBlur = 0;
      if (effect && effectAge < 2.2) {
        const pulse = 1 + Math.sin(effectAge * 12) * 0.3;
        const r = (14 + effectAge * 8) * pulse * zoom;
        const alpha = Math.max(0, 0.5 - effectAge * 0.25);
        ctx.strokeStyle = `rgba(253,216,53,${alpha})`;
        ctx.lineWidth = 2;
        ctx.beginPath(); ctx.arc(sx, sy, r, 0, Math.PI*2); ctx.stroke();
        bloomCtx.strokeStyle = `rgba(255,193,7,${alpha*0.6})`;
        bloomCtx.lineWidth = 3;
        bloomCtx.beginPath(); bloomCtx.arc(sx, sy, r, 0, Math.PI*2); bloomCtx.stroke();
      }
      ctx.fillStyle = '#fdd835'; ctx.font = '9px Segoe UI'; ctx.textAlign = 'center';
      ctx.fillText(`${a.res}`, sx, sy-14);
      bloomCtx.fillStyle = 'rgba(255,143,0,.3)';
      bloomCtx.beginPath(); bloomCtx.arc(sx, sy, 14, 0, Math.PI*2); bloomCtx.fill();
    }
  }

  function drawMissions() {
    for (const m of missionsArr) {
      const sx = (m.x-camera.x)*zoom, sy = (m.y-camera.y)*zoom;
      const stx = (m.tx-camera.x)*zoom, sty = (m.ty-camera.y)*zoom;
      if (m.type === 'attack') {
        ctx.setLineDash([4,6]); ctx.strokeStyle = 'rgba(255,82,82,.2)'; ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(sx,sy); ctx.lineTo(stx,sty); ctx.stroke(); ctx.setLineDash([]);
        const angle = Math.atan2(m.ty-m.y, m.tx-m.x);
        // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö —Ç–æ—á–µ–∫ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ —Ñ–ª–æ—Ç–∞
        const dotCount = Math.min(Math.max(3, Math.ceil(m.fleetCount / 5)), 12);
        for (let fi = 0; fi < dotCount; fi++) {
          const row = Math.floor(fi / 4);
          const col = fi % 4;
          const spread = (col - (Math.min(dotCount, 4) - 1) / 2) * 5;
          const rowOffset = row * 6;
          const fx = sx + Math.cos(angle+Math.PI/2)*spread - Math.cos(angle)*rowOffset;
          const fy = sy + Math.sin(angle+Math.PI/2)*spread - Math.sin(angle)*rowOffset;
          ctx.fillStyle = '#ff5252';
          ctx.beginPath(); ctx.arc(fx, fy, 3, 0, Math.PI*2); ctx.fill();
        }
        const tailX = sx-Math.cos(angle)*20, tailY = sy-Math.sin(angle)*20;
        const grad = ctx.createLinearGradient(sx,sy,tailX,tailY);
        grad.addColorStop(0,'rgba(255,82,82,.5)'); grad.addColorStop(1,'rgba(255,82,82,0)');
        ctx.strokeStyle = grad; ctx.lineWidth = 3;
        ctx.beginPath(); ctx.moveTo(sx,sy); ctx.lineTo(tailX,tailY); ctx.stroke();
        bloomCtx.fillStyle = 'rgba(255,82,82,.5)';
        bloomCtx.beginPath(); bloomCtx.arc(sx,sy,8,0,Math.PI*2); bloomCtx.fill();
        // –ò–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ—Ä–∞–±–ª–µ–π
        ctx.fillStyle = '#ff8a80'; ctx.font = '9px Segoe UI'; ctx.textAlign = 'center';
        ctx.fillText(m.owner, sx, sy-18);
        // –ë–µ–π–¥–∂ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∫–æ—Ä–∞–±–ª–µ–π
        const shipLabel = `${m.fleetCount || '?'}`;
        const tw = ctx.measureText(shipLabel).width;
        const bx = sx - tw/2 - 4, by = sy - 14;
        ctx.fillStyle = 'rgba(255,82,82,.7)';
        ctx.beginPath();
        ctx.roundRect(bx, by, tw + 8, 13, 3);
        ctx.fill();
        ctx.fillStyle = '#fff'; ctx.font = 'bold 9px Segoe UI';
        ctx.fillText(shipLabel, sx, sy - 4);
      } else {
        const angle = Math.atan2(m.ty-m.y, m.tx-m.x);
        ctx.fillStyle = m.type === 'return' ? '#66bb6a' : '#fdd835';
        ctx.beginPath(); ctx.arc(sx, sy, 2.5, 0, Math.PI*2); ctx.fill();
        const tailX = sx-Math.cos(angle)*12, tailY = sy-Math.sin(angle)*12;
        const col = m.type === 'return' ? '102,187,106' : '253,216,53';
        const grad = ctx.createLinearGradient(sx,sy,tailX,tailY);
        grad.addColorStop(0,`rgba(${col},.4)`); grad.addColorStop(1,`rgba(${col},0)`);
        ctx.strokeStyle = grad; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.moveTo(sx,sy); ctx.lineTo(tailX,tailY); ctx.stroke();
      }
    }
  }

  function drawPlanets() {
    for (const p of playersArr) drawPlanet(p);
  }

  function drawPlanet(p) {
    const sx = (p.x-camera.x)*zoom, sy = (p.y-camera.y)*zoom;
    const r = planetRadius(p.lvl) * zoom;
    if (sx < -r*4 || sx > canvas.width+r*4 || sy < -r*4 || sy > canvas.height+r*4) return;
    const isMe = p.nick === myNick;
    const pulse = 1 + Math.sin(animFrame*0.04+p.x)*0.02;
    const pr = r * pulse;

    ctx.shadowColor = p.color; ctx.shadowBlur = 25;
    const grad = ctx.createRadialGradient(sx-pr*.3, sy-pr*.3, pr*.1, sx, sy, pr);
    grad.addColorStop(0, lighten(p.color,40));
    grad.addColorStop(0.6, p.color);
    grad.addColorStop(1, darken(p.color,45));
    ctx.fillStyle = grad;
    ctx.beginPath(); ctx.arc(sx, sy, pr, 0, Math.PI*2); ctx.fill();
    ctx.shadowBlur = 0;

    bloomCtx.shadowColor = p.color; bloomCtx.shadowBlur = 30;
    bloomCtx.fillStyle = p.color; bloomCtx.globalAlpha = .4;
    bloomCtx.beginPath(); bloomCtx.arc(sx,sy,pr,0,Math.PI*2); bloomCtx.fill();
    bloomCtx.shadowBlur = 0; bloomCtx.globalAlpha = 1;

    const atmGrad = ctx.createRadialGradient(sx,sy,pr,sx,sy,pr+6);
    const ac = isMe ? '124,77,255' : '200,200,255';
    atmGrad.addColorStop(0,`rgba(${ac},.25)`); atmGrad.addColorStop(1,`rgba(${ac},0)`);
    ctx.fillStyle = atmGrad;
    ctx.beginPath(); ctx.arc(sx,sy,pr+6,0,Math.PI*2); ctx.fill();

    if (p.defense > 0) {
      ctx.strokeStyle = `rgba(77,208,225,${Math.min(.4, p.defense*.01)})`;
      ctx.lineWidth = 2; ctx.setLineDash([6,3]);
      ctx.beginPath(); ctx.arc(sx,sy,pr+8,0,Math.PI*2); ctx.stroke(); ctx.setLineDash([]);
    }

    // –ó–∞—â–∏—Ç–∞ –Ω–æ–≤–∏—á–∫–∞ ‚Äî –∑–µ–ª—ë–Ω—ã–π –ø—É–ª—å—Å–∏—Ä—É—é—â–∏–π –∫—Ä—É–≥
    if (isProtectedClient(p)) {
      const pa = .3 + Math.sin(animFrame * .06) * .15;
      ctx.strokeStyle = `rgba(102,187,106,${pa})`; ctx.lineWidth = 2.5; ctx.setLineDash([8,4]);
      ctx.beginPath(); ctx.arc(sx,sy,pr+14,0,Math.PI*2); ctx.stroke(); ctx.setLineDash([]);
    }

    if (selecting && !isMe) {
      if (isProtectedClient(p)) {
        // –ó–∞—â–∏—â—ë–Ω–Ω–∞—è –ø–ª–∞–Ω–µ—Ç–∞ ‚Äî —Å–µ—Ä—ã–π –∫—Ä—É–≥ –≤–º–µ—Å—Ç–æ –∫—Ä–∞—Å–Ω–æ–≥–æ
        ctx.strokeStyle = 'rgba(150,150,150,.3)'; ctx.lineWidth = 2; ctx.setLineDash([5,5]);
      } else {
        ctx.strokeStyle = 'rgba(255,82,82,.5)'; ctx.lineWidth = 2; ctx.setLineDash([5,5]);
      }
      ctx.beginPath(); ctx.arc(sx,sy,pr+12,animFrame*.05,animFrame*.05+Math.PI*2); ctx.stroke(); ctx.setLineDash([]);
    }

    if (p.lvl > 4) {
      const rc = Math.min(p.lvl-4, 3);
      for (let ri = 0; ri < rc; ri++) {
        ctx.strokeStyle = `rgba(255,255,255,${.12-ri*.03})`; ctx.lineWidth = 1.5;
        ctx.beginPath(); ctx.ellipse(sx,sy,pr+14+ri*7,(pr+14+ri*7)*.3,.3,0,Math.PI*2); ctx.stroke();
      }
    }

    const mc = Math.min(p.lvl, 8);
    for (let mi = 0; mi < mc; mi++) {
      const ma = (animFrame*.01*(1+mi*.3)) + (mi*Math.PI*2/mc);
      const md = pr+20+mi*5;
      ctx.fillStyle = 'rgba(200,200,220,.75)';
      ctx.beginPath(); ctx.arc(sx+Math.cos(ma)*md, sy+Math.sin(ma)*md*.55, 2.5, 0, Math.PI*2); ctx.fill();
    }

    if (p.fleet > 0) {
      const fs = Math.min(p.fleet, 24);
      for (let fi = 0; fi < fs; fi++) {
        const fa = (animFrame*.025)+(fi*Math.PI*2/fs), fd = pr+10;
        ctx.fillStyle = isMe ? 'rgba(124,77,255,.9)' : 'rgba(255,200,50,.7)';
        ctx.fillRect(sx+Math.cos(fa)*fd-1.5, sy+Math.sin(fa)*fd-1.5, 3, 3);
      }
    }

    ctx.fillStyle = isMe ? '#b388ff' : (p.online ? '#ccc' : '#555');
    ctx.font = 'bold 12px Segoe UI'; ctx.textAlign = 'center';
    const displayNick = p.isBot ? `${p.nick} [AI]` : p.nick;
    ctx.fillText(displayNick, sx, sy-pr-12);
    if (p.allianceName) {
      ctx.fillStyle = 'rgba(179,136,255,.7)'; ctx.font = '9px Segoe UI';
      ctx.fillText(`[${p.allianceName}]`, sx, sy-pr+2);
    }
    if (isProtectedClient(p)) {
      ctx.fillStyle = 'rgba(102,187,106,.8)'; ctx.font = '9px Segoe UI';
      ctx.fillText(t('protectedLabel'), sx, sy-pr-24);
    }
    ctx.fillStyle = '#888'; ctx.font = '10px Segoe UI';
    ctx.fillText(`—É—Ä.${p.lvl}  F:${p.fleet}  D:${p.defense}`, sx, sy+pr+18);
  }

  function drawExplosions() {
    for (let i = explosions.length-1; i >= 0; i--) {
      const exp = explosions[i]; let allDead = true;
      for (const part of exp.particles) {
        part.x += part.vx; part.y += part.vy;
        part.vx *= .98; part.vy *= .98; part.life -= .015;
        if (part.life <= 0) continue; allDead = false;
        const sx = (part.x-camera.x)*zoom, sy = (part.y-camera.y)*zoom;
        ctx.globalAlpha = part.life; ctx.fillStyle = part.color;
        ctx.beginPath(); ctx.arc(sx,sy,3.5*part.life,0,Math.PI*2); ctx.fill();
        bloomCtx.globalAlpha = part.life*.6; bloomCtx.fillStyle = part.color;
        bloomCtx.beginPath(); bloomCtx.arc(sx,sy,6*part.life,0,Math.PI*2); bloomCtx.fill();
      }
      ctx.globalAlpha = 1; bloomCtx.globalAlpha = 1;
      if (allDead) explosions.splice(i, 1);
    }
  }

  function drawMinimap() {
    const mw = mmCanvas.width, mh = mmCanvas.height;
    const sx = mw/MAP_W, sy = mh/MAP_H;
    mmCtx.clearRect(0,0,mw,mh);
    mmCtx.fillStyle = 'rgba(10,10,26,.7)'; mmCtx.fillRect(0,0,mw,mh);
    for (const a of asteroidsArr) { mmCtx.fillStyle = '#ff8f00'; mmCtx.fillRect(a.x*sx-1,a.y*sy-1,2,2); }
    for (const m of missionsArr) { mmCtx.fillStyle = m.type==='attack'?'#ff5252':'#fdd835'; mmCtx.fillRect(m.x*sx-1,m.y*sy-1,2,2); }
    for (const p of playersArr) {
      const isMe = p.nick === myNick;
      mmCtx.fillStyle = isMe ? '#b388ff' : (p.online ? p.color : '#444');
      mmCtx.beginPath(); mmCtx.arc(p.x*sx, p.y*sy, isMe?3:2, 0, Math.PI*2); mmCtx.fill();
    }
    mmCtx.strokeStyle = 'rgba(124,77,255,.6)'; mmCtx.lineWidth = 1;
    mmCtx.strokeRect(camera.x*sx, camera.y*sy, (canvas.width/zoom)*sx, (canvas.height/zoom)*sy);
  }

  mmCanvas.addEventListener('click', (e) => {
    const rect = mmCanvas.getBoundingClientRect();
    camera.x = ((e.clientX-rect.left)/mmCanvas.width)*MAP_W - canvas.width/(2*zoom);
    camera.y = ((e.clientY-rect.top)/mmCanvas.height)*MAP_H - canvas.height/(2*zoom);
  });

  draw();
})();
</script>
</body>
</html>
